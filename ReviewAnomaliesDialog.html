<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 20px; }
    h2 { color: #d93025; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
    th { background-color: #f2f2f2; }
    input { width: 90%; padding: 6px; }
    button { padding: 10px 15px; border: none; background-color: #4CAF50; color: white; cursor: pointer; border-radius: 4px; margin-top: 15px; }
    button:disabled { background-color: #ccc; }
    .price { color: #5f6368; }
    .cost { color: #d93025; font-weight: bold; }
  </style>
</head>
<body>
  <h2>Revisar Anomalías de Costo</h2>
  <p>Se encontraron las siguientes filas donde el <strong>Costo de Adquisición</strong> es mayor que el <strong>Precio de Venta</strong>. Por favor, introduce el costo correcto para cada línea.</p>

  <form id="review-form">
    <table id="anomalies-table">
      <thead>
        <tr>
          <th>Producto</th>
          <th>Precio Venta</th>
          <th>Costo Incorrecto</th>
          <th>Costo Correcto</th>
        </tr>
      </thead>
      <tbody>
        <!-- Rows will be dynamically inserted here -->
      </tbody>
    </table>
    <button type="submit">Guardar Correcciones</button>
  </form>

  <script>
    const anomalies = <?= anomaliesJSON ?>;
    const form = document.getElementById('review-form');
    const tableBody = document.querySelector("#anomalies-table tbody");

    // Populate the table with anomalies
    window.onload = function() {
      if (!anomalies || anomalies.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="4">No se encontraron anomalías.</td></tr>';
        form.querySelector('button').disabled = true;
        return;
      }

      let tableHtml = '';
      anomalies.forEach(item => {
        tableHtml += `
          <tr>
            <td>${item.productName}</td>
            <td class="price">${item.salePrice.toLocaleString('es-CL', {style:'currency', currency: 'CLP'})}</td>
            <td class="cost">${item.incorrectCost.toLocaleString('es-CL', {style:'currency', currency: 'CLP'})}</td>
            <td><input type="number" step="any" name="correctedCost" data-rownumber="${item.rowNumber}" required></td>
          </tr>
        `;
      });
      tableBody.innerHTML = tableHtml;
    };

    // Handle form submission
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      const button = form.querySelector('button');
      button.disabled = true;
      button.textContent = 'Guardando...';

      const corrections = [];
      const inputs = form.querySelectorAll('input[name="correctedCost"]');

      inputs.forEach(input => {
        if (input.value) {
          corrections.push({
            rowNumber: parseInt(input.dataset.rownumber, 10),
            newCost: parseFloat(input.value)
          });
        }
      });

      google.script.run
        .withSuccessHandler(function(response) {
          alert(response);
          google.script.host.close();
        })
        .withFailureHandler(function(err) {
          alert('Error al guardar: ' + err.message);
          button.disabled = false;
          button.textContent = 'Guardar Correcciones';
        })
        .saveCorrectedCosts(corrections);
    });
  </script>
</body>
</html>
