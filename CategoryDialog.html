<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: #f0f2f5; color: #333; }
    .container { padding: 20px; }
    h1 { color: #1c1e21; margin-top: 0; }
    .category-list { margin-top: 15px; max-height: 250px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; background-color: #fff; border-radius: 4px; }
    .category-item { display: block; margin-bottom: 10px; }
    label { font-size: 14px; display: flex; align-items: center; }
    input[type="checkbox"] { margin-right: 10px; width: 18px; height: 18px; }
    .footer-actions {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      padding: 15px 20px;
      background-color: #fff;
      border-top: 1px solid #ddd;
      text-align: right;
      box-sizing: border-box;
    }
    .button {
      padding: 10px 20px;
      font-size: 14px;
      font-weight: bold;
      border-radius: 5px;
      border: none;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    #generate-btn { background-color: #1877f2; color: white; }
    #generate-btn:disabled { background-color: #dcdfe3; color: #bec3c9; cursor: not-allowed; }
    #cancel-btn { background-color: #e4e6eb; color: #4b4f56; margin-left: 10px; }
    #status { margin-right: 15px; color: #606770; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Paso 2: Seleccionar Categorías para Envasado</h1>
    <p>Elige las categorías de productos para las que deseas generar la lista de envasado.</p>
    <div id="category-list" class="category-list">
      <!-- Las categorías se insertarán aquí dinámicamente -->
    </div>
  </div>

  <div class="footer-actions">
      <span id="status">Cargando categorías...</span>
      <button id="generate-btn" class="button" disabled>Generar Lista</button>
      <button id="cancel-btn" class="button" onclick="google.script.host.close()">Cancelar</button>
  </div>

  <script>
    const categoryListDiv = document.getElementById('category-list');
    const generateBtn = document.getElementById('generate-btn');
    const statusSpan = document.getElementById('status');

    window.onload = function() {
      google.script.run
        .withSuccessHandler(renderCategories)
        .withFailureHandler(handleError)
        .getPackagingData();
    };

    function renderCategories(categoryData) {
      if (Object.keys(categoryData).length === 0) {
        categoryListDiv.innerHTML = '<p>No hay categorías con productos para envasar.</p>';
        statusSpan.textContent = 'Listo.';
        return;
      }

      let categoryHtml = '';
      const sortedCategories = Object.keys(categoryData).sort();

      sortedCategories.forEach(category => {
        const productCount = Object.keys(categoryData[category].products).length;
        categoryHtml += `
          <div class="category-item">
            <label>
              <input type="checkbox" name="category" value="${category}">
              ${category} (${productCount} producto${productCount > 1 ? 's' : ''})
            </label>
          </div>
        `;
      });

      categoryListDiv.innerHTML = categoryHtml;
      statusSpan.textContent = 'Listo para seleccionar.';
      generateBtn.disabled = false;
    }

    generateBtn.addEventListener('click', function() {
      const selectedCategories = [];
      const checkboxes = document.querySelectorAll('input[name="category"]:checked');
      checkboxes.forEach(checkbox => {
        selectedCategories.push(checkbox.value);
      });

      if (selectedCategories.length === 0) {
        alert('Por favor, selecciona al menos una categoría.');
        return;
      }

      setLoadingState(true, 'Generando lista...');

      google.script.run
        .withSuccessHandler(handleGenerationSuccess)
        .withFailureHandler(handleError)
        .generatePackagingSheet(selectedCategories);
    });

    function handleGenerationSuccess(printUrl) {
      statusSpan.textContent = '¡Lista generada!';

      // Create a link and show it to the user.
      const link = document.createElement('a');
      link.href = printUrl;
      link.target = '_blank';
      link.textContent = 'Abrir PDF para Imprimir';
      link.style.marginRight = '15px';

      const footer = document.querySelector('.footer-actions');
      footer.insertBefore(link, statusSpan);

      generateBtn.style.display = 'none'; // Hide button after use

      // Optionally close the dialog after a delay
      setTimeout(() => {
        google.script.host.close();
      }, 5000); // Close after 5 seconds
    }

    function handleError(error) {
      setLoadingState(false, `Error: ${error.message}`);
      alert(`Ocurrió un error: ${error.message}`);
    }

    function setLoadingState(isLoading, message) {
      generateBtn.disabled = isLoading;
      statusSpan.textContent = message;
    }
  </script>
</body>
</html>
