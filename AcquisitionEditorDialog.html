<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: #f0f2f5; color: #333; }
    .container { padding: 20px; padding-bottom: 80px; }
    h1 { color: #1c1e21; margin-top: 0; }
    .filters { margin-top: 15px; margin-bottom: 15px; display: flex; gap: 20px; }
    .filters label { font-weight: bold; display: flex; align-items: center; gap: 5px; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { padding: 12px 8px; text-align: left; border-bottom: 1px solid #ddd; }
    th { font-weight: bold; font-size: 13px; color: #606770; background-color: #f5f6f7; }
    td { font-size: 14px; vertical-align: middle; }
    tr:hover { background-color: #f5f5f5; }
    .low-stock-warning, .low-stock-warning:hover {
      background-color: #fff3cd !important;
    }
    .negative-stock-error, .negative-stock-error:hover {
      background-color: #f8d7da !important;
      color: #721c24;
    }
    .inventory-correction-input {
      width: 70px;
      margin-left: 10px;
      border-color: #721c24;
      background-color: #f9e6e8;
    }
    input, select {
      width: 95%;
      padding: 8px;
      font-size: 14px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    .footer-actions {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      padding: 15px 20px;
      background-color: #fff;
      border-top: 1px solid #ddd;
      text-align: right;
      box-sizing: border-box;
    }
    .button {
      padding: 10px 20px;
      font-size: 14px;
      font-weight: bold;
      border-radius: 5px;
      border: none;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    #save-btn { background-color: #1877f2; color: white; }
    #save-btn:disabled { background-color: #dcdfe3; color: #bec3c9; cursor: not-allowed; }
    #cancel-btn { background-color: #e4e6eb; color: #4b4f56; margin-left: 10px; }
    #just-in-time-btn, #wholesale-btn { background-color: #f0f2f5; color: #050505; border: 1px solid #bec3c9; margin-right: 10px; }
    #status { margin-right: 15px; color: #606770; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Editar Borrador de Adquisiciones</h1>
    <div class="filters">
      <label>Categoría:
        <select id="category-filter">
          <option value="">Todas</option>
        </select>
      </label>
      <label>Proveedor:
        <select id="supplier-filter">
          <option value="">Todos</option>
        </select>
      </label>
      <label>Buscar por Producto:
        <input type="text" id="product-search-filter" placeholder="Escriba para filtrar..." style="width: 200px;">
      </label>
    </div>
    <p>La lista carga por defecto en modo "Mayorista". Usa los botones para recalcular según necesites.</p>
    <table id="acquisitions-table">
      <thead>
        <tr>
          <th>Producto Base</th>
          <th>Inventario Actual</th>
          <th>Necesidad Venta</th>
          <th>Cantidad a Comprar (Sugerida)</th>
          <th>Formato de Compra</th>
          <th>Proveedor</th>
          <th>Inventario al Finalizar</th>
        </tr>
      </thead>
      <tbody>
        <!-- Las filas de datos se insertarán aquí dinámicamente -->
      </tbody>
    </table>
  </div>

  <div class="footer-actions">
      <span id="status">Cargando datos...</span>
      <button id="wholesale-btn" class="button">Calcular Compra Mayorista</button>
      <button id="just-in-time-btn" class="button">Calcular Compra Justa</button>
      <button id="show-all-btn" class="button">Mostrar productos sin necesidad de compra</button>
      <button id="save-btn" class="button" disabled>Guardar y Notificar</button>
      <button id="cancel-btn" class="button" onclick="google.script.host.close()">Cancelar</button>
  </div>

  <script>
    let planData = [];
    let allSuppliers = [];
    let allCategories = [];
    const tableBody = document.querySelector("#acquisitions-table tbody");
    const saveBtn = document.getElementById('save-btn');
    const justInTimeBtn = document.getElementById('just-in-time-btn');
    const wholesaleBtn = document.getElementById('wholesale-btn');
    const showAllBtn = document.getElementById('show-all-btn');
    const statusSpan = document.getElementById('status');
    const categorySelect = document.getElementById('category-filter');
    const supplierFilter = document.getElementById('supplier-filter');
    const productSearchFilter = document.getElementById('product-search-filter');

    function processPlanData(plan) {
       plan.forEach(item => {
          item.allFormatObjects = [...item.availableFormats];
          item.allFormatStrings = item.availableFormats.map(f => `${f.name} (${f.size} ${f.unit})`);
          item.selectedFormatString = `${item.suggestedFormat.name} (${item.suggestedFormat.size} ${item.suggestedFormat.unit})`;
        });
        return plan;
    }

    window.onload = function() {
      try {
        const serverData = <?!= JSON.stringify(data) ?>;
        allSuppliers = serverData.allSuppliers;
        allCategories = serverData.allCategories;
        planData = processPlanData(serverData.acquisitionPlan);

        // Populate filters
        allCategories.forEach(cat => {
            const opt = document.createElement('option');
            opt.value = cat;
            opt.textContent = cat;
            categorySelect.appendChild(opt);
        });
        allSuppliers.forEach(sp => {
            const opt = document.createElement('option');
            opt.value = sp;
            opt.textContent = sp;
            supplierFilter.appendChild(opt);
        });

        categorySelect.addEventListener('change', renderTable);
        supplierFilter.addEventListener('change', renderTable);
        productSearchFilter.addEventListener('input', renderTable);

        renderTable();
        statusSpan.textContent = 'Listo para editar.';
        saveBtn.disabled = false;

        tableBody.addEventListener('input', function(e) {
          if (e.target.classList.contains('quantity-input') || e.target.classList.contains('format-select') || e.target.classList.contains('supplier-select') || e.target.classList.contains('inventory-correction-input')) {
            const row = e.target.closest('tr');
            if (!row) return;
            const index = parseInt(row.getAttribute('data-index'), 10);

            if (e.target.classList.contains('quantity-input')) {
              planData[index].suggestedQty = e.target.value;
            }
            if (e.target.classList.contains('format-select')) {
              planData[index].selectedFormatString = e.target.value;
            }
            if (e.target.classList.contains('supplier-select')) {
              planData[index].supplier = e.target.value;
            }

            updateRowAppearance(row, planData[index]);
          }
        });

      } catch (e) {
        console.error("Error al procesar los datos iniciales:", e);
        statusSpan.textContent = 'Error al cargar los datos.';
        alert("No se pudieron cargar los datos para el editor. Error: " + e.message);
      }
    };

    function calculateFinalInventory(item, quantity, formatString, currentInventory) {
      const selectedFormat = item.allFormatObjects.find(f => `${f.name} (${f.size} ${f.unit})` === formatString);
      const formatSize = selectedFormat ? selectedFormat.size : 0;
      const purchasedAmount = (parseFloat(quantity) || 0) * formatSize;
      const finalInventory = (currentInventory || 0) + purchasedAmount - (parseFloat(item.totalNeed) || 0);
      return finalInventory.toFixed(2);
    }

    function updateRowAppearance(row, item) {
      let inventoryForCalc = item.currentInventory;
      const correctionInput = row.querySelector('.inventory-correction-input');
      
      if (correctionInput) {
        inventoryForCalc = parseFloat(correctionInput.value) || 0;
      }
      
      const quantity = row.querySelector('.quantity-input').value;
      const formatString = row.querySelector('.format-select').value;
      const finalInventory = calculateFinalInventory(item, quantity, formatString, inventoryForCalc);
      const finalInventoryCell = row.querySelector('.final-inventory');

      row.classList.remove('low-stock-warning');
      
      if (parseFloat(finalInventory) < 0) {
        finalInventoryCell.textContent = 'REVISAR INVENTARIO';
      } else {
        finalInventoryCell.textContent = `${finalInventory} ${item.unit}`;
        if (parseFloat(finalInventory) < 3) {
          row.classList.add('low-stock-warning');
        }
      }
    }

    function renderTable() {
      const selectedCategory = categorySelect.value;
      const selectedSupplier = supplierFilter.value;
      const searchTerm = productSearchFilter.value.toLowerCase();

      const filteredItems = planData.filter(item => {
          const catOk = !selectedCategory || item.category === selectedCategory;
          const supplierOk = !selectedSupplier || item.supplier === selectedSupplier;
          const searchOk = !searchTerm || item.productName.toLowerCase().includes(searchTerm);
          return catOk && supplierOk && searchOk;
      });

      const neededItems = filteredItems.filter(item => parseFloat(item.suggestedQty) > 0);
      const notNeededItems = filteredItems.filter(item => !(parseFloat(item.suggestedQty) > 0));

      tableBody.innerHTML = '';

      const renderItem = (item) => {
        const index = planData.indexOf(item);
        const row = document.createElement('tr');
        row.setAttribute('data-index', index);

        let inventoryCellHtml;
        if (item.currentInventory < 0) {
          row.classList.add('negative-stock-error');
          inventoryCellHtml = `
            <td class="negative-stock-cell">
              <span>${item.currentInventory} ${item.currentInventoryUnit}</span>
              <input type="number" class="inventory-correction-input" placeholder="Corregir" value="0" step="any">
            </td>`;
        } else {
          inventoryCellHtml = `<td>${item.currentInventory} ${item.currentInventoryUnit}</td>`;
        }

        row.innerHTML = `
          <td>${item.productName}</td>
          ${inventoryCellHtml}
          <td>${item.totalNeed} ${item.unit}</td>
          <td><input type="number" class="quantity-input" value="${item.suggestedQty}" min="0" step="any"></td>
          <td><select class="format-select">${createOptions(item.allFormatStrings, item.selectedFormatString)}</select></td>
          <td><select class="supplier-select">${createOptions(allSuppliers, item.supplier)}</select></td>
          <td class="final-inventory"></td>
        `;
        tableBody.appendChild(row);
        updateRowAppearance(row, item);
      };

      neededItems.forEach(renderItem);

      if (notNeededItems.length > 0 && neededItems.length > 0) {
        const separatorRow = document.createElement('tr');
        separatorRow.innerHTML = `<th colspan="7" style="text-align: center; background-color: #e9ecef; color: #495057; font-size: 14px; padding: 10px;">Productos sin necesidad de compra inmediata</th>`;
        tableBody.appendChild(separatorRow);
      }

      notNeededItems.forEach(renderItem);
    }

    function createOptions(optionsArray, selectedValue) {
      return optionsArray.map(option =>
        `<option value="${option}" ${option === selectedValue ? 'selected' : ''}>${option}</option>`
      ).join('');
    }

    saveBtn.addEventListener('click', function() {
      setLoadingState(true, 'Guardando cambios...');

      const finalPlan = planData.map(item => ({
          ...item,
          quantity: item.suggestedQty,
          selectedFormatString: item.selectedFormatString,
          supplier: item.supplier
      }));

      google.script.run
        .withSuccessHandler(handleSaveSuccess)
        .withFailureHandler(handleError)
        .saveAcquisitions(finalPlan);
    });

    function handleSaveSuccess(response) {
      setLoadingState(false, '¡Guardado! Listo para notificar.');
      alert(response.message);

      const saveBtn = document.getElementById('save-btn');
      saveBtn.textContent = 'Ir al Panel de Notificación';

      const newSaveBtn = saveBtn.cloneNode(true);
      saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);

      newSaveBtn.addEventListener('click', () => {
        setLoadingState(true, 'Abriendo notificaciones...');
        google.script.run
          .withSuccessHandler(() => google.script.host.close())
          .withFailureHandler(handleError)
          .openNotificationPanel();
      });
    }

    function handleError(error) {
      setLoadingState(false, `Error: ${error.message}`);
      alert(`Ocurrió un error: ${error.message}`);
    }

    function setLoadingState(isLoading, message) {
      saveBtn.disabled = isLoading;
      justInTimeBtn.disabled = isLoading;
      wholesaleBtn.disabled = isLoading;
      showAllBtn.disabled = isLoading;
      statusSpan.textContent = message;
    }

    function handleDataSuccess(newData) {
      planData = processPlanData(newData.acquisitionPlan);
      allSuppliers = newData.allSuppliers;
      allCategories = newData.allCategories;
      renderTable();
    }

    wholesaleBtn.addEventListener('click', function() {
      setLoadingState(true, 'Calculando compra mayorista...');
      google.script.run
        .withSuccessHandler(function(newData) {
          handleDataSuccess(newData);
          setLoadingState(false, 'Cálculo mayorista completado.');
        })
        .withFailureHandler(handleError)
        .getAcquisitionDataForEditor('wholesale');
    });

    justInTimeBtn.addEventListener('click', function() {
      setLoadingState(true, 'Calculando compra justa...');
      google.script.run
        .withSuccessHandler(function(newData) {
          handleDataSuccess(newData);
          setLoadingState(false, 'Cálculo de compra justa completado.');
        })
        .withFailureHandler(handleError)
        .getAcquisitionDataForEditor('just-in-time');
    });

    showAllBtn.addEventListener('click', function() {
      setLoadingState(true, 'Cargando todos los productos...');
      google.script.run
        .withSuccessHandler(function(newData) {
          handleDataSuccess(newData);
          setLoadingState(false, 'Se han cargado todos los productos.');
        })
        .withFailureHandler(handleError)
        .getAcquisitionDataForEditor('all');
    });
  </script>
</body>
</html>
