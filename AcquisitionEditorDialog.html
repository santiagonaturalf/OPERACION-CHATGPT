<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: #f0f2f5; color: #333; }
    .container { padding: 20px; /* padding-bottom will be set dynamically */ }
    h1 { color: #1c1e21; margin-top: 0; }
    .filters { margin-top: 15px; margin-bottom: 15px; display: flex; gap: 20px; flex-wrap: wrap; }
    .filters label { font-weight: bold; display: flex; align-items: center; gap: 5px; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { padding: 12px 8px; text-align: left; border-bottom: 1px solid #ddd; }
    th { font-weight: bold; font-size: 13px; color: #606770; background-color: #f5f6f7; }
    td { font-size: 14px; vertical-align: middle; }
    tr:hover { background-color: #f5f5f5; }
    .low-stock-warning, .low-stock-warning:hover {
      background-color: #fff3cd !important;
    }
    .negative-stock-error, .negative-stock-error:hover {
      background-color: #f8d7da !important;
      color: #721c24;
    }
    .inventory-correction-input {
      width: 70px;
      margin-left: 10px;
      border-color: #721c24;
      background-color: #f9e6e8;
    }
    input, select {
      width: 95%;
      padding: 8px;
      font-size: 14px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    .footer-actions {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      padding: 15px 20px;
      background-color: #fff;
      border-top: 1px solid #ddd;
      box-sizing: border-box;
      /* Use flexbox for better alignment and wrapping */
      display: flex;
      flex-wrap: wrap;
      justify-content: flex-end;
      align-items: center;
      gap: 10px;
    }
    .button {
      padding: 10px 15px; /* Adjusted padding for better fit */
      font-size: 14px;
      font-weight: bold;
      border-radius: 5px;
      border: none;
      cursor: pointer;
      transition: background-color 0.2s;
      white-space: nowrap; /* Prevent buttons from breaking line */
    }
    #save-btn { background-color: #1877f2; color: white; }
    #save-btn:disabled { background-color: #dcdfe3; color: #bec3c9; cursor: not-allowed; }
    #cancel-btn { background-color: #e4e6eb; color: #4b4f56; }
    #clear-list-btn { background-color: #dc3545; color: white; }
    #just-in-time-btn, #wholesale-btn, #show-all-btn { background-color: #f0f2f5; color: #050505; border: 1px solid #bec3c9; }
    #status { margin-right: auto; /* Pushes status to the left */ color: #606770; }
    /* --- Tooltip Styles --- */
    .breakdown-tooltip {
        display: none;
        position: absolute;
        border: 1px solid #ccc;
        background-color: white;
        padding: 10px;
        z-index: 1000;
        max-width: 450px;
        border-radius: 6px;
        box-shadow: 0 3px 8px rgba(0,0,0,0.15);
        font-size: 13px;
        line-height: 1.4;
    }
    .breakdown-tooltip h4 {
        margin-top: 0;
        font-size: 15px;
        border-bottom: 1px solid #eee;
        padding-bottom: 8px;
        margin-bottom: 8px;
    }
    .breakdown-tooltip ul {
        margin: 0;
        padding-left: 20px;
    }
    .breakdown-tooltip li {
        margin-bottom: 5px;
    }
    .add-format-btn {
      padding: 4px 9px;
      font-size: 14px;
      font-weight: bold;
      line-height: 1;
      cursor: pointer;
      border: 1px solid #ccc;
      background-color: #f0f0f0;
      border-radius: 4px;
      flex-shrink: 0; /* Prevents the button from shrinking */
    }
    .add-format-btn:hover {
      background-color: #e0e0e0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Editar Borrador de Adquisiciones</h1>
    <div class="filters">
      <label>Categoría:
        <select id="category-filter">
          <option value="">Todas</option>
        </select>
      </label>
      <label>Proveedor:
        <select id="supplier-filter">
          <option value="">Todos</option>
        </select>
      </label>
      <label>Buscar por Producto:
        <input type="text" id="product-search-filter" placeholder="Escriba para filtrar..." style="width: 200px;">
      </label>
      <label style="display: flex; align-items: center; cursor: pointer;">
        <input type="checkbox" id="review-filter" style="width: auto; margin-right: 5px;">
        Mostrar solo para revisar
      </label>
      <label style="display: flex; align-items: center; cursor: pointer;">
        <input type="checkbox" id="toggle-breakdown-cb" style="width: auto; margin-right: 5px;" checked>
        Activar Desglose en Hover
      </label>
       <label style="display: flex; align-items: center; cursor: pointer; border-left: 2px solid #ccc; padding-left: 20px;">
        <input type="checkbox" id="unapproved-filter" style="width: auto; margin-right: 5px;">
        Mostrar solo no aprobados
      </label>
    </div>
    <p>La lista carga por defecto en modo "Mayorista". Usa los botones para recalcular según necesites.</p>
    <table id="acquisitions-table">
      <thead>
        <tr>
          <th style="width: 50px; text-align: center;">
            <input type="checkbox" id="select-all-checkbox" title="Seleccionar todo lo visible">
            Aprobado
          </th>
          <th>Producto Base</th>
          <th>Inventario Actual</th>
          <th>Necesidad Venta</th>
          <th>Cantidad a Comprar (Sugerida)</th>
          <th>Formato de Compra</th>
          <th>Proveedor</th>
          <th>Inventario al Finalizar</th>
        </tr>
      </thead>
      <tbody>
        <!-- Las filas de datos se insertarán aquí dinámicamente -->
      </tbody>
    </table>
  </div>

  <div class="footer-actions">
      <span id="status">Cargando datos...</span>
      <button id="wholesale-btn" class="button">Calcular Compra Mayorista</button>
      <button id="just-in-time-btn" class="button">Calcular Compra Justa</button>
      <button id="show-all-btn" class="button">Mostrar productos sin necesidad de compra</button>
      <button id="clear-list-btn" class="button" style="background-color: #dc3545; color: white;">Limpiar Lista de Adquisiciones</button>
      <button id="save-btn" class="button" disabled>Guardar y Notificar</button>
      <button id="cancel-btn" class="button" onclick="google.script.host.close()">Cancelar</button>
  </div>

  <script>
    let planData = [];
    let allSuppliers = [];
    let allCategories = [];
    let showReviewHeader = false;
    const tableBody = document.querySelector("#acquisitions-table tbody");
    const saveBtn = document.getElementById('save-btn');
    const justInTimeBtn = document.getElementById('just-in-time-btn');
    const wholesaleBtn = document.getElementById('wholesale-btn');
    const showAllBtn = document.getElementById('show-all-btn');
    const clearListBtn = document.getElementById('clear-list-btn');
    const statusSpan = document.getElementById('status');
    const categorySelect = document.getElementById('category-filter');
    const supplierFilter = document.getElementById('supplier-filter');
    const productSearchFilter = document.getElementById('product-search-filter');
    const reviewFilter = document.getElementById('review-filter');
    const unapprovedFilter = document.getElementById('unapproved-filter');

    function processPlanData(plan) {
       plan.forEach(item => {
          item.allFormatObjects = [...item.availableFormats];
          item.allFormatStrings = item.availableFormats.map(f => `${f.name} (${f.size} ${f.unit})`);
          item.selectedFormatString = `${item.suggestedFormat.name} (${item.suggestedFormat.size} ${item.suggestedFormat.unit})`;
          item.correctedInventory = null;
        });
        return plan;
    }

    window.onload = function() {
      try {
        const serverData = <?!= JSON.stringify(data) ?>;
        allSuppliers = serverData.allSuppliers;
        allCategories = serverData.allCategories;
        planData = processPlanData(serverData.acquisitionPlan);

        allCategories.forEach(cat => {
            const opt = document.createElement('option');
            opt.value = cat;
            opt.textContent = cat;
            categorySelect.appendChild(opt);
        });
        allSuppliers.forEach(sp => {
            const opt = document.createElement('option');
            opt.value = sp;
            opt.textContent = sp;
            supplierFilter.appendChild(opt);
        });

        categorySelect.addEventListener('change', renderTable);
        supplierFilter.addEventListener('change', renderTable);
        productSearchFilter.addEventListener('input', renderTable);
        reviewFilter.addEventListener('change', renderTable);
        unapprovedFilter.addEventListener('change', renderTable);

        tableBody.addEventListener('mouseover', handleMouseOver);
        tableBody.addEventListener('mouseout', handleMouseOut);
        tableBody.addEventListener('mousemove', handleMouseMove);

        renderTable();
        statusSpan.textContent = 'Listo para editar.';
        saveBtn.disabled = false;

        tableBody.addEventListener('input', function(e) {
          const row = e.target.closest('tr');
          if (!row) return;
          const index = parseInt(row.getAttribute('data-index'), 10);
          if (planData[index]) {
            if (e.target.classList.contains('quantity-input')) {
              planData[index].suggestedQty = e.target.value;
            } else if (e.target.classList.contains('format-select')) {
              planData[index].selectedFormatString = e.target.value;
            } else if (e.target.classList.contains('supplier-select')) {
              planData[index].supplier = e.target.value;
            } else if (e.target.classList.contains('inventory-correction-input')) {
              const value = parseFloat(e.target.value);
              planData[index].correctedInventory = isNaN(value) ? null : value;
            }
            updateRowAppearance(row, planData[index]);
          }
        });

        const selectAllCheckbox = document.getElementById('select-all-checkbox');
        selectAllCheckbox.addEventListener('change', function() {
          const isChecked = this.checked;
          const visibleRows = tableBody.querySelectorAll('tr[data-index]');

          visibleRows.forEach(row => {
            const index = parseInt(row.getAttribute('data-index'), 10);
            const checkbox = row.querySelector('.approved-checkbox');
            if (checkbox && checkbox.checked !== isChecked) {
              checkbox.checked = isChecked;
              if (planData[index]) {
                  planData[index].approved = isChecked;
              }
            }
          });
          this.indeterminate = false;
        });

        tableBody.addEventListener('change', function(e) {
            if (e.target.classList.contains('approved-checkbox')) {
                const row = e.target.closest('tr');
                if (!row) return;
                const index = parseInt(row.getAttribute('data-index'), 10);
                if (planData[index]) {
                    planData[index].approved = e.target.checked;
                }
                updateSelectAllCheckboxState();
            }
        });

        tableBody.addEventListener('click', function(e) {
          if (e.target.classList.contains('add-format-btn')) {
            e.preventDefault();
            const row = e.target.closest('tr');
            if (!row) return;
            const index = parseInt(row.getAttribute('data-index'), 10);
            const productBase = planData[index].productName;
            handleAddNewFormat(productBase, index);
          }
        });

        const container = document.querySelector('.container');
        const footer = document.querySelector('.footer-actions');
        function adjustContainerPadding() {
          if (footer) {
            const footerHeight = footer.offsetHeight;
            container.style.paddingBottom = (footerHeight + 20) + 'px';
          }
        }
        adjustContainerPadding();
        window.addEventListener('resize', adjustContainerPadding);

      } catch (e) {
        console.error("Error al procesar los datos iniciales:", e);
        statusSpan.textContent = 'Error al cargar los datos.';
        alert("No se pudieron cargar los datos para el editor. Error: " + e.message);
      }
    };

    function calculateFinalInventory(item, quantity, formatString, currentInventory) {
      const selectedFormat = item.allFormatObjects.find(f => `${f.name} (${f.size} ${f.unit})` === formatString);
      const formatSize = selectedFormat ? selectedFormat.size : 0;
      const purchasedAmount = (parseFloat(quantity) || 0) * formatSize;
      const finalInventory = (currentInventory || 0) + purchasedAmount - (parseFloat(item.totalNeed) || 0);
      return finalInventory.toFixed(2);
    }

    function updateRowAppearance(row, item) {
      const inventoryForCalc = (typeof item.correctedInventory === 'number' && !isNaN(item.correctedInventory))
        ? item.correctedInventory
        : item.currentInventory;
      const quantity = item.suggestedQty;
      const formatString = item.selectedFormatString;
      const finalInventory = calculateFinalInventory(item, quantity, formatString, inventoryForCalc);
      const finalInventoryCell = row.querySelector('.final-inventory');
      row.classList.remove('low-stock-warning');
      if (parseFloat(finalInventory) < 0) {
        finalInventoryCell.textContent = 'REVISAR INVENTARIO';
      } else {
        finalInventoryCell.textContent = `${finalInventory} ${item.unit}`;
        if (parseFloat(finalInventory) < 3) {
          row.classList.add('low-stock-warning');
        }
      }
    }

    function renderTable() {
      const selectedCategory = categorySelect.value;
      const selectedSupplier = supplierFilter.value;
      const searchTerm = productSearchFilter.value.toLowerCase();
      const showOnlyReview = reviewFilter.checked;
      const showOnlyUnapproved = unapprovedFilter.checked;
      tableBody.innerHTML = '';

      if (showReviewHeader) {
        const anyItemNeedsReview = planData.some(item => {
            const inventoryForCalc = (typeof item.correctedInventory === 'number' && !isNaN(item.correctedInventory)) ? item.correctedInventory : item.currentInventory;
            const finalInventory = calculateFinalInventory(item, item.suggestedQty, item.selectedFormatString, inventoryForCalc);
            return parseFloat(finalInventory) < 0;
        });
        if (anyItemNeedsReview) {
            const separatorRow = document.createElement('tr');
            separatorRow.classList.add('review-alert-header');
            separatorRow.innerHTML = `<th colspan="8" style="text-align: center; background-color: #f8d7da; color: #721c24; font-size: 16px; padding: 12px; border-top: 2px solid #721c24; border-bottom: 2px solid #721c24;">🚨 ¡Atención! Se requiere revisar el inventario de las siguientes filas. 🚨</th>`;
            tableBody.appendChild(separatorRow);
        }
      }

      const filteredItems = planData.filter(item => {
          const catOk = !selectedCategory || item.category === selectedCategory;
          const supplierOk = !selectedSupplier || item.supplier === selectedSupplier;
          const searchOk = !searchTerm || item.productName.toLowerCase().includes(searchTerm);
          if (!(catOk && supplierOk && searchOk)) return false;
          if (showOnlyUnapproved && item.approved) return false;
          if (showOnlyReview) {
            const inventoryForCalc = (typeof item.correctedInventory === 'number' && !isNaN(item.correctedInventory)) ? item.correctedInventory : item.currentInventory;
            const finalInventory = calculateFinalInventory(item, item.suggestedQty, item.selectedFormatString, inventoryForCalc);
            return parseFloat(finalInventory) < 0;
          }
          return true;
      });

      const neededItems = filteredItems.filter(item => parseFloat(item.suggestedQty) > 0);
      const notNeededItems = filteredItems.filter(item => !(parseFloat(item.suggestedQty) > 0));

      const renderItem = (item) => {
        const index = planData.indexOf(item);
        const row = document.createElement('tr');
        row.setAttribute('data-index', index);
        if (item.breakdown && item.breakdown.length > 0) {
          row.setAttribute('data-breakdown', JSON.stringify(item.breakdown));
        }
        let inventoryCellHtml;
        if (item.currentInventory < 0) {
          row.classList.add('negative-stock-error');
          inventoryCellHtml = `
            <td class="negative-stock-cell">
              <span>${item.currentInventory} ${item.currentInventoryUnit}</span>
              <input type="number" class="inventory-correction-input" placeholder="Corregir" value="${(typeof item.correctedInventory === 'number' && !isNaN(item.correctedInventory)) ? item.correctedInventory : ''}" step="any">
            </td>`;
        } else {
          inventoryCellHtml = `<td>${item.currentInventory} ${item.currentInventoryUnit}</td>`;
        }
        row.innerHTML = `
          <td style="text-align: center;"><input type="checkbox" class="approved-checkbox" style="width: auto;" ${item.approved ? 'checked' : ''}></td>
          <td class="product-base-cell">${item.productName}</td>
          ${inventoryCellHtml}
          <td>${item.totalNeed} ${item.unit}</td>
          <td><input type="number" class="quantity-input" value="${item.suggestedQty}" min="0" step="any"></td>
          <td>
            <div style="display: flex; align-items: center; gap: 4px;">
              <select class="format-select" style="width: auto; flex-grow: 1;">${createOptions(item.allFormatStrings, item.selectedFormatString)}</select>
              <button type="button" class="add-format-btn" title="Crear nuevo formato de compra para este producto" data-product-base="${item.productName}">+</button>
            </div>
          </td>
          <td><select class="supplier-select">${createOptions(allSuppliers, item.supplier)}</select></td>
          <td class="final-inventory"></td>
        `;
        tableBody.appendChild(row);
        updateRowAppearance(row, item);
      };

      neededItems.forEach(renderItem);
      if (notNeededItems.length > 0 && neededItems.length > 0) {
        const separatorRow = document.createElement('tr');
        separatorRow.innerHTML = `<th colspan="8" style="text-align: center; background-color: #e9ecef; color: #495057; font-size: 14px; padding: 10px;">Productos sin necesidad de compra inmediata</th>`;
        tableBody.appendChild(separatorRow);
      }
      notNeededItems.forEach(renderItem);
      updateSelectAllCheckboxState();
    }

    function updateSelectAllCheckboxState() {
      const selectAllCheckbox = document.getElementById('select-all-checkbox');
      const visibleCheckboxes = Array.from(tableBody.querySelectorAll('tr .approved-checkbox'));
      if (visibleCheckboxes.length === 0) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
        return;
      }
      const checkedCount = visibleCheckboxes.filter(cb => cb.checked).length;
      if (checkedCount === 0) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
      } else if (checkedCount === visibleCheckboxes.length) {
        selectAllCheckbox.checked = true;
        selectAllCheckbox.indeterminate = false;
      } else {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = true;
      }
    }

    function handleAddNewFormat(productBase, index) {
      if (document.getElementById('add-format-modal-overlay')) return;
      const modalOverlay = document.createElement('div');
      modalOverlay.id = 'add-format-modal-overlay';
      Object.assign(modalOverlay.style, {
        position: 'fixed', top: 0, left: 0, width: '100%', height: '100%',
        backgroundColor: 'rgba(0, 0, 0, 0.6)', zIndex: 1001,
        display: 'flex', justifyContent: 'center', alignItems: 'center'
      });
      const modalContent = document.createElement('div');
      Object.assign(modalContent.style, {
        background: 'white', padding: '25px', borderRadius: '8px',
        boxShadow: '0 5px 15px rgba(0,0,0,0.3)', width: '400px'
      });
      const supplierOptions = allSuppliers.map(s => `<option value="${s}">${s}</option>`).join('');
      modalContent.innerHTML = `
        <h3 style="margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 10px;">Añadir Nuevo Formato de Compra</h3>
        <p>Para el producto base: <strong>${productBase}</strong></p>
        <div style="display: flex; flex-direction: column; gap: 15px;">
          <label>Nombre del Formato (ej. Caja, Saco):<input type="text" id="new-format-name" style="width: 95%;" required></label>
          <label>Cantidad Compra (ej. 12, 25):<input type="number" id="new-format-quantity" style="width: 95%;" required step="any"></label>
          <label>Unidad Compra (ej. Kg, Litro, Unidad):<input type="text" id="new-format-unit" style="width: 95%;" required list="unit-suggestions"><datalist id="unit-suggestions"><option value="Kg"></option><option value="Gr"></option><option value="Litro"></option><option value="Unidad"></option><option value="Bandeja"></option></datalist></label>
          <label>Proveedor:<select id="new-format-supplier" style="width: 100%;">${supplierOptions}</select></label>
        </div>
        <div style="margin-top: 25px; text-align: right; display: flex; gap: 10px; justify-content: flex-end;">
          <button type="button" id="cancel-new-format-btn" class="button">Cancelar</button>
          <button type="button" id="save-new-format-btn" class="button" style="background-color: #1877f2; color: white;">Guardar Formato</button>
        </div>`;
      modalOverlay.appendChild(modalContent);
      document.body.appendChild(modalOverlay);
      document.getElementById('new-format-name').focus();
      const closeModal = () => { if (document.body.contains(modalOverlay)) document.body.removeChild(modalOverlay); };
      document.getElementById('cancel-new-format-btn').addEventListener('click', closeModal);
      modalOverlay.addEventListener('click', (e) => { if (e.target === modalOverlay) closeModal(); });
      document.getElementById('save-new-format-btn').addEventListener('click', () => {
        const newFormatData = {
          productBase: productBase, rowIndex: index,
          formatName: document.getElementById('new-format-name').value.trim(),
          formatQuantity: parseFloat(document.getElementById('new-format-quantity').value),
          formatUnit: document.getElementById('new-format-unit').value.trim(),
          supplier: document.getElementById('new-format-supplier').value
        };
        if (!newFormatData.formatName || isNaN(newFormatData.formatQuantity) || newFormatData.formatQuantity <= 0 || !newFormatData.formatUnit) {
          alert('Por favor, complete todos los campos del formato correctamente.'); return;
        }
        const saveBtn = document.getElementById('save-new-format-btn');
        saveBtn.textContent = 'Guardando...'; saveBtn.disabled = true;
        google.script.run
          .withSuccessHandler(function(response) {
            if (response.status === 'success') {
              const item = planData[newFormatData.rowIndex];
              item.allFormatObjects = response.allFormatObjects;
              item.allFormatStrings = response.allFormatStrings;
              item.selectedFormatString = response.newFormatString;
              const row = tableBody.querySelector(`tr[data-index="${newFormatData.rowIndex}"]`);
              if (row) {
                 const formatCell = row.cells[5];
                 formatCell.innerHTML = `<div style="display: flex; align-items: center; gap: 4px;"><select class="format-select" style="width: auto; flex-grow: 1;">${createOptions(item.allFormatStrings, item.selectedFormatString)}</select><button type="button" class="add-format-btn" title="Crear nuevo formato de compra para este producto" data-product-base="${item.productName}">+</button></div>`;
              }
              closeModal();
            } else { throw new Error(response.message || 'Ocurrió un error inesperado en el servidor.'); }
          })
          .withFailureHandler(function(error) {
            alert('Error al guardar el formato: ' + error.message);
            saveBtn.textContent = 'Guardar Formato'; saveBtn.disabled = false;
          })
          .addNewSku(newFormatData);
      });
    }

    function createOptions(optionsArray, selectedValue) {
      return optionsArray.map(option =>
        `<option value="${option}" ${option === selectedValue ? 'selected' : ''}>${option}</option>`
      ).join('');
    }

    function handleMouseOver(e) {
        if (!document.getElementById('toggle-breakdown-cb').checked) { const tooltip = document.getElementById('breakdown-tooltip'); if (tooltip) tooltip.style.display = 'none'; return; }
        if (e.target.classList.contains('product-base-cell')) {
            const row = e.target.closest('tr'); if (!row) return;
            const breakdownData = row.getAttribute('data-breakdown'); if (!breakdownData) return;
            let tooltip = document.getElementById('breakdown-tooltip'); if (!tooltip) { tooltip = document.createElement('div'); tooltip.id = 'breakdown-tooltip'; document.body.appendChild(tooltip); }
            try {
                const breakdown = JSON.parse(breakdownData);
                if (breakdown.length > 0) {
                    let html = '<h4>Desglose de Necesidad</h4><ul>';
                    breakdown.forEach(order => { html += `<li><b>${order.quantity} x ${order.productName}</b><br><small>(Pedido: ${order.orderId}, Cliente: ${order.customerName})</small></li>`; });
                    html += '</ul>';
                    tooltip.innerHTML = html; tooltip.className = 'breakdown-tooltip'; tooltip.style.display = 'block';
                }
            } catch (err) { console.error("Error parsing breakdown data:", err); if(tooltip) tooltip.style.display = 'none'; }
        }
    }
    function handleMouseOut(e) { if (e.target.classList.contains('product-base-cell')) { const tooltip = document.getElementById('breakdown-tooltip'); if (tooltip) tooltip.style.display = 'none'; } }
    function handleMouseMove(e) { const tooltip = document.getElementById('breakdown-tooltip'); if (tooltip && tooltip.style.display === 'block') { tooltip.style.left = (e.pageX + 15) + 'px'; tooltip.style.top = (e.pageY + 15) + 'px'; } }

    saveBtn.addEventListener('click', function() {
      showReviewHeader = true;
      renderTable();
      setLoadingState(true, 'Guardando cambios...');
      const finalPlan = planData.map(item => ({
          ...item,
          quantity: item.suggestedQty,
          selectedFormatString: item.selectedFormatString,
          supplier: item.supplier,
          approved: item.approved
      }));
      google.script.run
        .withSuccessHandler(handleSaveSuccess)
        .withFailureHandler(handleError)
        .saveAcquisitions(finalPlan);
    });

    function handleSaveSuccess(response) {
      setLoadingState(false, '¡Guardado! Listo para notificar.');
      alert(response.message);
      const saveBtn = document.getElementById('save-btn');
      saveBtn.textContent = 'Ir al Panel de Notificación';
      const newSaveBtn = saveBtn.cloneNode(true);
      saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);
      newSaveBtn.addEventListener('click', () => {
        setLoadingState(true, 'Abriendo notificaciones...');
        google.script.run
          .withSuccessHandler(() => google.script.host.close())
          .withFailureHandler(handleError)
          .openNotificationPanel();
      });
    }

    function handleError(error) {
      setLoadingState(false, `Error: ${error.message}`);
      alert(`Ocurrió un error: ${error.message}`);
    }

    function setLoadingState(isLoading, message) {
      saveBtn.disabled = isLoading;
      justInTimeBtn.disabled = isLoading;
      wholesaleBtn.disabled = isLoading;
      showAllBtn.disabled = isLoading;
      if(clearListBtn) clearListBtn.disabled = isLoading;
      statusSpan.textContent = message;
    }

    function handleDataSuccess(newData) {
      planData = processPlanData(newData.acquisitionPlan);
      allSuppliers = newData.allSuppliers;
      allCategories = newData.allCategories;
      renderTable();
    }

    wholesaleBtn.addEventListener('click', function() {
      setLoadingState(true, 'Calculando compra mayorista...');
      google.script.run
        .withSuccessHandler(function(newData) { handleDataSuccess(newData); setLoadingState(false, 'Cálculo mayorista completado.'); })
        .withFailureHandler(handleError)
        .getAcquisitionDataForEditor('wholesale');
    });

    justInTimeBtn.addEventListener('click', function() {
      setLoadingState(true, 'Calculando compra justa...');
      google.script.run
        .withSuccessHandler(function(newData) { handleDataSuccess(newData); setLoadingState(false, 'Cálculo de compra justa completado.'); })
        .withFailureHandler(handleError)
        .getAcquisitionDataForEditor('just-in-time');
    });

    showAllBtn.addEventListener('click', function() {
      setLoadingState(true, 'Cargando todos los productos...');
      google.script.run
        .withSuccessHandler(function(newData) { handleDataSuccess(newData); setLoadingState(false, 'Se han cargado todos los productos.'); })
        .withFailureHandler(handleError)
        .getAcquisitionDataForEditor('all');
    });

    clearListBtn.addEventListener('click', function() {
      if (confirm("¿Estás seguro de que deseas limpiar permanentemente la 'Lista de Adquisiciones'? Esta acción no se puede deshacer.")) {
        setLoadingState(true, 'Limpiando lista...');
        google.script.run
          .withSuccessHandler(function(response) {
            alert(response.message);
            setLoadingState(true, 'Recargando datos...');
            google.script.run
              .withSuccessHandler(function(newData) { handleDataSuccess(newData); setLoadingState(false, 'La lista ha sido limpiada y los datos recargados.'); })
              .withFailureHandler(handleError)
              .getAcquisitionDataForEditor('wholesale');
          })
          .withFailureHandler(handleError)
          .clearAcquisitionsList();
      }
    });
  </script>
</body>
</html>
