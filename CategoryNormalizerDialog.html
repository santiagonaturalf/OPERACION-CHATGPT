<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css">
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .container { display: flex; flex-direction: column; }
    .section { margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px; }
    .group { border: 1px solid #ddd; border-radius: 4px; padding: 15px; margin-bottom: 15px; background-color: #f9f9f9; }
    .group h4 { margin-top: 0; color: #333; }
    .variations { font-style: italic; color: #666; margin-bottom: 10px; }
    label { font-weight: bold; display: block; margin-bottom: 5px; }
    input[type="text"] { width: 95%; padding: 8px; border-radius: 4px; border: 1px solid #ccc; }
    .buttons { margin-top: 20px; text-align: right; }
    button { margin-left: 10px; }
    #no-category-list { list-style-type: disc; padding-left: 20px; }
    #loader { display: block; text-align: center; padding: 20px; }
  </style>
</head>
<body>
  <div class="container">
    <h3>Normalizador Global de Categorías</h3>
    <div id="loader"><p>Analizando categorías...</p></div>

    <div id="main-content" style="display:none;">
      <!-- Section 1: Normalization Groups -->
      <div id="variations-section" class="section">
        <h4>Grupos de Categorías a Unificar</h4>
        <p>Revisa los grupos de categorías similares y establece un nombre único para cada uno.</p>
        <form id="normalization-form">
          <!-- Groups will be dynamically inserted here -->
        </form>
      </div>

      <!-- Section 2: Products without category -->
      <div id="no-category-section" class="section">
        <h4>Productos Sin Categoría</h4>
        <p>Los siguientes productos no tienen una categoría asignada en la hoja SKU.</p>
        <ul id="no-category-list">
          <!-- Product names will be inserted here -->
        </ul>
      </div>

      <div class="buttons">
        <button type="button" class="action" id="submit-button">Normalizar Categorías</button>
        <button type="button" id="close-button">Cerrar</button>
      </div>
    </div>
  </div>

  <script>
    const loader = document.getElementById('loader');
    const mainContent = document.getElementById('main-content');
    const form = document.getElementById('normalization-form');
    const noCategoryList = document.getElementById('no-category-list');
    const submitButton = document.getElementById('submit-button');

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
      google.script.run
        .withSuccessHandler(renderDialog)
        .withFailureHandler(showError)
        .getCategoryVariations();
    });

    function renderDialog(data) {
      loader.style.display = 'none';
      mainContent.style.display = 'block';

      // Render variations form
      const variations = data.variations || {};
      if (Object.keys(variations).length === 0) {
        form.innerHTML = '<p>No se encontraron grupos de categorías para unificar.</p>';
        submitButton.style.display = 'none';
      } else {
        for (const suggestion in variations) {
          const originalVariations = variations[suggestion];
          const groupDiv = document.createElement('div');
          groupDiv.className = 'group';
          groupDiv.innerHTML = `
            <h4>Grupo de Variaciones</h4>
            <p class="variations">Encontrado: ${originalVariations.join(', ')}</p>
            <label>Normalizar a:</label>
            <input type="text" value="${suggestion}" data-variations='${JSON.stringify(originalVariations)}'>
          `;
          form.appendChild(groupDiv);
        }
      }

      // Render products without category
      const productsWithoutCategory = data.productsWithoutCategory || [];
      if (productsWithoutCategory.length === 0) {
        noCategoryList.innerHTML = '<li>¡Excelente! Todos los productos tienen una categoría.</li>';
      } else {
        productsWithoutCategory.forEach(productName => {
          const li = document.createElement('li');
          li.textContent = productName;
          noCategoryList.appendChild(li);
        });
      }
    }

    // --- EVENT LISTENERS ---
    submitButton.addEventListener('click', handleSubmit);
    document.getElementById('close-button').addEventListener('click', () => google.script.host.close());

    // --- SUBMISSION LOGIC ---
    function handleSubmit() {
      const inputs = form.querySelectorAll('input[type="text"]');
      for (const input of inputs) {
        if (input.value.trim() === '') {
          alert('El nombre de la categoría no puede estar vacío.');
          return;
        }
      }

      submitButton.disabled = true;
      submitButton.textContent = 'Guardando...';

      const fixes = {};
      inputs.forEach(input => {
        const normalizedValue = input.value.trim();
        const originalVariations = JSON.parse(input.dataset.variations);
        originalVariations.forEach(variation => {
          if (variation !== normalizedValue) {
            fixes[variation] = normalizedValue;
          }
        });
      });

      if (Object.keys(fixes).length === 0) {
        alert("No se realizaron cambios en las categorías.");
        google.script.host.close();
        return;
      }

      google.script.run
        .withSuccessHandler(response => {
          alert(response);
          google.script.host.close();
        })
        .withFailureHandler(showError)
        .applyCategoryFixes(fixes);
    }

    function showError(error) {
      loader.style.display = 'none';
      alert('Error: ' + error.message);
      if (submitButton.disabled) {
        submitButton.disabled = false;
        submitButton.textContent = 'Normalizar Categorías';
      }
    }
  </script>
</body>
</html>
