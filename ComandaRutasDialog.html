<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: #f0f2f5; color: #333; }
    .container { padding: 20px; }
    h1, h2 { color: #1c1e21; }
    .card { background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 8px; text-align: left; border-bottom: 1px solid #eee; }
    th { font-weight: bold; font-size: 12px; color: #606770; }
    td { font-size: 14px; }
    input, select, textarea { width: 100%; padding: 6px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
    .action-button {
      padding: 12px 18px; font-size: 14px; font-weight: bold; border-radius: 5px;
      border: none; cursor: pointer; transition: background-color 0.2s; color: white; margin-right: 10px;
    }
    .action-button:disabled { background-color: #dcdfe3 !important; color: #bec3c9 !important; cursor: not-allowed;}
    #load-btn { background-color: #0d6efd; }
    #save-btn { background-color: #198754; }
    #process-btn { background-color: #ffc107; color: black; }
    #generate-btn { background-color: #6f42c1; }
    #status-log { font-size: 12px; font-style: italic; color: #606770; margin-top: 15px; min-height: 18px;}
    .textarea-container { width: 100%; }
    #routexl-input { height: 150px; font-family: monospace; }
    
    /* Styles for Preview Dashboard */
    .dashboard-row { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 15px; }
    .van-column { flex: 0 0 300px; background-color: #f9f9f9; border-radius: 6px; border: 1px solid #ddd; }
    .van-column h5 { margin: 0; padding: 10px; background-color: #e9ecef; border-bottom: 1px solid #ddd; border-radius: 6px 6px 0 0; }
    .van-column ul { list-style-type: none; padding: 10px; margin: 0; min-height: 50px; }
    .van-column li { background-color: white; padding: 8px; border: 1px solid #eee; border-radius: 4px; margin-bottom: 8px; font-size: 12px; display: flex; align-items: center; gap: 8px; }
    .move-order-checkbox { transform: scale(1.8); margin: 0 10px 0 4px; }
    .unassigned-column { border-color: #dc3545; }
    .unassigned-column h5 { background-color: #f8d7da; color: #721c24; }
    .unassigned-panel { border: 2px solid #dc3545; border-radius: 6px; background-color: #fff; margin-bottom: 20px; }
    .unassigned-header { padding: 10px; background-color: #f8d7da; border-bottom: 2px solid #dc3545; display: flex; gap: 10px; align-items: center; }
    .unassigned-header h5 { color: #721c24; margin: 0; }
    .unassigned-list { max-height: 250px; overflow-y: auto; padding: 10px; }
    .unassigned-list ul { list-style-type: none; padding: 0; margin: 0; }
    .unassigned-list li { background-color: #fff; padding: 8px; border-bottom: 1px solid #eee; font-size: 12px; display: flex; align-items: center; gap: 8px; }
    .unassigned-list li:last-child { border-bottom: none; }

    /* Styles for RouteXL Accordion */
    .routexl-accordion-header { display: flex; justify-content: space-between; align-items: center; padding: 10px; background-color: #f7f7f7; border: 1px solid #ddd; cursor: pointer; font-weight: bold; }
    .routexl-accordion-header:hover { background-color: #e9e9e9; }
    .routexl-accordion-content { display: none; padding: 10px; border: 1px solid #ddd; border-top: none; }

    /* Styles for Error Modal */
    .error-modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
    .error-modal-content { background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 700px; border-radius: 8px; box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2); }
    .error-modal-content h3 { color: #c00; margin-top: 0; }
    .error-modal-content pre { white-space: pre-wrap; word-wrap: break-word; background-color: #f3f3f3; padding: 15px; border: 1px solid #ccc; max-height: 250px; overflow-y: auto; }
    .error-modal-footer { text-align: right; margin-top: 15px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üöö Comanda Rutas</h1>

    <div class="card">
      <h2>Paso 1: Formatear Direcciones y Asignar Furg√≥n</h2>
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; gap: 10px;">
        <input type="text" id="order-search-input" placeholder="Buscar en tabla..." style="flex-grow: 1; padding: 8px;">
        <select id="commune-filter-select" style="width: 200px; padding: 8px;">
          <option value="">Filtrar por Comuna</option>
        </select>
        <select id="bulk-van-select" style="width: 200px; padding: 8px;">
          <option value="">Asignar Furg√≥n...</option>
        </select>
        <button id="bulk-assign-btn" class="action-button" style="background-color: #5bc0de; flex-shrink: 0;">Asignar</button>
      </div>
      <div id="status-log">Cargando pedidos...</div>
      <div style="max-height: 400px; overflow-y: auto; margin-top: 15px;">
        <table id="orders-table">
          <thead>
            <tr>
              <th>N¬∫ Pedido</th>
              <th>Cliente</th>
              <th>Tel√©fono</th>
              <th>Direcci√≥n</th>
              <th>Depto.</th>
              <th>Comuna</th>
              <th>Estado</th>
              <th>Furg√≥n</th>
            </tr>
          </thead>
          <tbody>
            <!-- Las filas de pedidos se insertar√°n aqu√≠ din√°micamente -->
          </tbody>
        </table>
      </div>
    </div>

    <div class="card">
        <h2>Paso 1.75: Previsualizaci√≥n y Ajustes Finales</h2>
        <p>Genera una vista previa de los pedidos agrupados por furg√≥n. Aqu√≠ puedes realizar ajustes de √∫ltima hora antes de generar la lista para RouteXL.</p>
        <div>
            <button id="generate-preview-btn" class="action-button" style="background-color: #6610f2;">Generar/Actualizar Previsualizaci√≥n</button>
        </div>
        <div id="preview-panel" style="margin-top: 15px;">
            <div id="preview-action-bar" style="padding-bottom: 15px; border-bottom: 1px solid #ccc; margin-bottom: 15px; display: none; gap: 10px; align-items: center;">
                <label for="move-target-van" style="font-weight: bold;">Mover a:</label>
                <select id="move-target-van" style="width: 200px; padding: 8px;"></select>
                <button id="move-selected-btn" class="action-button" style="background-color: #f0ad4e;">Mover Seleccionados</button>
            </div>
            <div id="preview-dashboard">
                <!-- El dashboard se generar√° aqu√≠ din√°micamente -->
            </div>
        </div>
    </div>

    <div class="card">
      <h2>Paso 1.5: Generar Listas para RouteXL</h2>
      <p>Genera las listas de direcciones por furg√≥n para pegar en RouteXL. Solo se incluir√°n los pedidos que tengan un furg√≥n asignado.</p>
      <div>
        <button id="generate-list-btn" class="action-button" style="background-color: #0d6efd;">Generar Listas</button>
      </div>
      <div id="routexl-output-container" style="margin-top: 15px;">
        <!-- Las listas por furg√≥n se generar√°n aqu√≠ din√°micamente -->
      </div>
    </div>

    <div class="card">
      <h2>Paso 2: Procesar Orden de RouteXL</h2>
      <p>Selecciona el furg√≥n correspondiente y pega aqu√≠ el texto copiado desde RouteXL para ordenar los pedidos.</p>
      <div class="textarea-container">
        <textarea id="routexl-input" placeholder="Pega aqu√≠ el contenido de RouteXL..."></textarea>
      </div>
      <div style="margin-top: 10px; display: flex; align-items: center; gap: 10px;">
        <select id="process-van-select" style="padding: 12px; border-radius: 5px; border: 1px solid #ccc;">
          <option value="">-- Seleccionar Furg√≥n --</option>
        </select>
        <button id="process-btn" class="action-button">Procesar Ruta</button>
      </div>
    </div>

    <div id="results-card" class="card" style="display:none; text-align: center;">
      <h2>Resultados de la Ruta</h2>
      <p id="results-message" style="margin-bottom: 15px;"></p>
      <div id="pdf-links-container"></div>
    </div>

    <div class="card">
      <h2>Mantenimiento</h2>
      <p>Usa este bot√≥n para eliminar todas las hojas de 'Envasado' y 'Ruta' que ya no necesites.</p>
      <div>
        <button id="cleanup-btn" class="action-button" style="background-color: #d9534f;">üóëÔ∏è Limpiar Hojas de Ruta Antiguas</button>
      </div>
    </div>

  </div>

  <datalist id="address-list"></datalist>
  <datalist id="department-list"></datalist>
  <datalist id="commune-list"></datalist>

  <script>
    // DOM Elements
    const statusLog = document.getElementById('status-log');
    const processBtn = document.getElementById('process-btn');
    const generateBtn = document.getElementById('generate-btn');
    const ordersTableBody = document.querySelector("#orders-table tbody");
    const routeXlInput = document.getElementById('routexl-input');
    const generatePreviewBtn = document.getElementById('generate-preview-btn');
    const previewPanel = document.getElementById('preview-panel');
    const generateListBtn = document.getElementById('generate-list-btn');

    // State
    const VANS = [
        'Furgon 1 Ma√±ana', 'Furgon 1 Tarde',
        'Furgon 2 Ma√±ana', 'Furgon 2 Tarde',
        'Furgon 3 Ma√±ana', 'Furgon 3 Tarde',
        'Furgon 4 Ma√±ana', 'Furgon 4 Tarde'
    ];

    // Initializer
    document.addEventListener('DOMContentLoaded', () => {
      loadInitialData();
      addEventListeners();
      populateBulkVanSelector();
      populateProcessVanSelector();
    });

    function populateBulkVanSelector() {
      const bulkVanSelect = document.getElementById('bulk-van-select');
      VANS.forEach(van => {
        const option = document.createElement('option');
        option.value = van;
        option.textContent = van;
        bulkVanSelect.appendChild(option);
      });
    }

    function populateProcessVanSelector() {
      const processVanSelect = document.getElementById('process-van-select');
      VANS.forEach(van => {
        const option = document.createElement('option');
        option.value = van;
        option.textContent = van;
        processVanSelect.appendChild(option);
      });
    }

    function addEventListeners() {
      ordersTableBody.addEventListener('change', (e) => {
        if (e.target.classList.contains('data-input')) {
          handleAutoSaveChanges(e.target);
        }
      });
      processBtn.addEventListener('click', handleProcessRoute);
      generateListBtn.addEventListener('click', handleGenerateRouteXLList);
      generatePreviewBtn.addEventListener('click', handleGeneratePreview);
      document.getElementById('cleanup-btn').addEventListener('click', handleCleanup);
      document.getElementById('order-search-input').addEventListener('keyup', handleOrderSearch);
      document.getElementById('commune-filter-select').addEventListener('change', handleCommuneFilter);
      document.getElementById('bulk-assign-btn').addEventListener('click', handleBulkAssign);
      document.getElementById('move-selected-btn').addEventListener('click', handleMoveSelectedOrders);

      // Combined listener for the RouteXL accordion (toggle and copy)
      document.getElementById('routexl-output-container').addEventListener('click', function(e) {
        const header = e.target.closest('.routexl-accordion-header');
        
        // Handle copy button clicks
        if (e.target.classList.contains('copy-van-list-btn')) {
            const textToCopy = e.target.dataset.copyText;
            if (textToCopy) {
                navigator.clipboard.writeText(textToCopy)
                    .then(() => alert('¬°Lista copiada al portapapeles!'))
                    .catch(err => alert('Error al copiar la lista.'));
            }
            return; // Stop further processing
        }

        // Handle header clicks for accordion toggle
        if (header) {
            const content = header.nextElementSibling;
            if (content && content.classList.contains('routexl-accordion-content')) {
                const isVisible = content.style.display === 'block';
                content.style.display = isVisible ? 'none' : 'block';
            }
        }
      });

      // Listener for the dynamically generated "Select by Commune" button
      previewPanel.addEventListener('click', function(e) {
        if (e.target && e.target.id === 'select-by-commune-btn') {
          handleSelectUnassignedByCommune();
        }
      });

      // Listeners for the error modal
      document.getElementById('close-error-btn').addEventListener('click', () => {
        document.getElementById('error-modal').style.display = 'none';
      });

      document.getElementById('copy-error-btn').addEventListener('click', () => {
        const errorMessage = document.getElementById('error-message-content').textContent;
        navigator.clipboard.writeText(errorMessage)
            .then(() => {
                const btn = document.getElementById('copy-error-btn');
                btn.textContent = '¬°Copiado!';
                setTimeout(() => { btn.textContent = 'Copiar Error'; }, 2000);
            })
            .catch(err => {
                alert('No se pudo copiar el error.');
            });
      });
    }

    function handleSearchUnassigned(input) {
      const searchTerm = input.value.toLowerCase();
      const listItems = document.querySelectorAll('#unassigned-orders-ul li');
      listItems.forEach(li => {
        const text = li.dataset.searchText.toLowerCase();
        if (text.includes(searchTerm)) {
          li.style.display = 'flex';
        } else {
          li.style.display = 'none';
        }
      });
    }

    function handleSelectUnassignedByCommune() {
      const selectedCommune = document.getElementById('unassigned-commune-filter').value;
      if (!selectedCommune) {
        alert('Por favor, selecciona una comuna del filtro.');
        return;
      }
      const listItems = document.querySelectorAll('#unassigned-orders-ul li');
      let found = 0;
      listItems.forEach(li => {
        // Only consider visible items for selection
        if (li.style.display !== 'none' && li.dataset.commune === selectedCommune) {
          const checkbox = li.querySelector('.move-order-checkbox');
          if (checkbox) {
            checkbox.checked = true;
            found++;
          }
        }
      });
      if (found === 0) {
        alert('No se encontraron pedidos visibles para la comuna seleccionada.');
      }
    }

    function handleMoveSelectedOrders() {
        const targetVan = document.getElementById('move-target-van').value;
        if (targetVan === '--UNASSIGN--') {
            // This is the separator, do nothing.
            return;
        }

        const checkboxes = document.querySelectorAll('.move-order-checkbox:checked');
        if (checkboxes.length === 0) {
            alert('Por favor, selecciona al menos un pedido para mover.');
            return;
        }

        let movedCount = 0;
        checkboxes.forEach(checkbox => {
            const orderNumber = checkbox.dataset.orderNumber;
            const mainTableRow = ordersTableBody.querySelector(`tr[data-order-number="${orderNumber}"]`);
            if (mainTableRow) {
                const mainVanSelect = mainTableRow.querySelector('select[data-field="van"]');
                if (mainVanSelect.value !== targetVan) {
                    mainVanSelect.value = targetVan;
                    // Dispatch change event to trigger auto-save
                    mainVanSelect.dispatchEvent(new Event('change', { bubbles: true }));
                    movedCount++;
                }
            }
        });

        if (movedCount > 0) {
            // Use a timeout to allow the multiple save events to be processed before refreshing the UI
            statusLog.textContent = 'Actualizando vista...';
            setTimeout(() => {
                handleGeneratePreview();
                statusLog.textContent = `${movedCount} pedido(s) movido(s).`;
            }, 800); // A slightly longer timeout to be safer
        } else {
            alert('No se realizaron cambios (los pedidos seleccionados ya estaban en el furg√≥n de destino).');
        }
    }

    function handleCommuneFilter(event) {
      const selectedCommune = event.target.value;
      const tableRows = ordersTableBody.querySelectorAll('tr');
      
      tableRows.forEach(row => {
        // The commune is in the 6th column (index 5), inside an input field
        const communeInput = row.cells[5].querySelector('input');
        if (communeInput) {
            const rowCommune = communeInput.value;
            if (selectedCommune === "" || rowCommune === selectedCommune) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        }
      });
    }
    
    // --- Generic Handlers ---
    function setLoadingState(isLoading, message = '') {
      statusLog.textContent = message;
      const allButtons = document.querySelectorAll('.action-button');
      allButtons.forEach(btn => {
        if(btn.id !== 'copy-list-btn') { // Don't disable copy button during loading
            btn.disabled = isLoading;
        }
      });
    }

    function handleSuccess(response) {
        setLoadingState(false);
        if (response && response.status === 'success' && response.packagingPdfUrl) {
            showPdfLinks(response);
        } else if (response && response.message) {
            alert(response.message);
        } else if (typeof response === 'string') {
            alert(response);
        } else {
            alert('Operaci√≥n completada.');
        }
    }

    function showPdfLinks(response) {
        const resultsCard = document.getElementById('results-card');
        const messageEl = document.getElementById('results-message');
        const linksContainer = document.getElementById('pdf-links-container');

        messageEl.textContent = response.message;
        
        let linksHtml = `
            <a href="${response.packagingPdfUrl}" target="_blank" class="action-button" style="background-color: #5cb85c; margin-bottom: 10px; display: inline-block; width: 80%; max-width: 400px;">Imprimir/Descargar PDF de Envasado (Vertical)</a>
            <br>
            <a href="${response.routePdfUrl}" target="_blank" class="action-button" style="background-color: #337ab7; display: inline-block; width: 80%; max-width: 400px;">Imprimir/Descargar PDF de Ruta (Horizontal)</a>
        `;
        linksContainer.innerHTML = linksHtml;

        resultsCard.style.display = 'block';
        statusLog.textContent = 'Proceso completado. Los enlaces para imprimir est√°n listos.';
    }

    function handleError(error) {
      setLoadingState(false, `Error: ${error.message}`);
      
      const modal = document.getElementById('error-modal');
      const messageContent = document.getElementById('error-message-content');
      
      messageContent.textContent = error.message;
      modal.style.display = 'block';
    }
    
    // --- Data Loading and UI Building ---
    function loadInitialData() {
      setLoadingState(true, 'Cargando datos iniciales...');
      google.script.run.withSuccessHandler(populateOrdersTable).withFailureHandler(handleError).getOrdersForRouting();
    }

    function populateOrdersTable(orders) {
      populateDatalists(orders);
      populateTable(orders);
      setLoadingState(false, `Se cargaron ${orders.length} pedidos √∫nicos.`);
    }

    function populateDatalists(orders) {
        const addressSet = new Set();
        const departmentSet = new Set();
        const communeSet = new Set();

        orders.forEach(order => {
            if (order.address) addressSet.add(order.address);
            if (order.department) departmentSet.add(order.department);
            if (order.commune) communeSet.add(order.commune);
        });

        const escapeHTML = str => String(str || '').replace(/"/g, '&quot;');

        // Datalists for autocomplete
        document.getElementById('address-list').innerHTML =
            [...addressSet].map(val => `<option value="${escapeHTML(val)}"></option>`).join('');
        document.getElementById('department-list').innerHTML =
            [...departmentSet].map(val => `<option value="${escapeHTML(val)}"></option>`).join('');
        document.getElementById('commune-list').innerHTML =
            [...communeSet].map(val => `<option value="${escapeHTML(val)}"></option>`).join('');
        
        // Also populate the filter dropdown from the same data
        const communeFilterSelect = document.getElementById('commune-filter-select');
        const sortedCommunes = [...communeSet].sort();
        communeFilterSelect.innerHTML = '<option value="">Filtrar por Comuna</option>';
        sortedCommunes.forEach(commune => {
            const option = document.createElement('option');
            option.value = commune;
            option.textContent = commune;
            communeFilterSelect.appendChild(option);
        });
    }

    function handleBulkAssign() {
      const selectedCommune = document.getElementById('commune-filter-select').value;
      const selectedVan = document.getElementById('bulk-van-select').value;

      if (!selectedCommune) {
        alert('Por favor, primero filtra por una comuna.');
        return;
      }
      if (!selectedVan) {
        alert('Por favor, selecciona un furg√≥n para asignar.');
        return;
      }

      const updatedOrders = [];
      let assignedCount = 0;

      ordersTableBody.querySelectorAll('tr').forEach(row => {
        // Process only visible rows
        if (row.style.display === 'none') {
          return;
        }
        
        const communeInput = row.querySelector('[data-field="commune"]');
        if (communeInput && communeInput.value === selectedCommune) {
          const vanSelect = row.querySelector('[data-field="van"]');
          if (vanSelect) {
            vanSelect.value = selectedVan;
            assignedCount++;
            
            // Collect data from the updated row to be saved.
            updatedOrders.push({
              orderNumber: row.dataset.orderNumber,
              phone: row.cells[2].textContent.trim(),
              address: row.querySelector('[data-field="address"]').value,
              department: row.querySelector('[data-field="department"]').value,
              commune: communeInput.value,
              van: vanSelect.value
            });
          }
        }
      });

      if (assignedCount > 0) {
        statusLog.textContent = `Asignando furg√≥n a ${assignedCount} pedidos...`;
        // Use the existing batch-update function on the backend
        google.script.run
          .withSuccessHandler(response => {
            // The success handler from the server returns a generic message,
            // so we use our own more specific alert for clarity.
            alert(`${assignedCount} pedidos de "${selectedCommune}" han sido asignados a "${selectedVan}". Cambios guardados.`);
            statusLog.textContent = 'Asignaci√≥n masiva completada.';
          })
          .withFailureHandler(handleError)
          .saveRouteChanges(updatedOrders);
      } else {
        alert('No se encontraron pedidos visibles que coincidan con la comuna seleccionada.');
      }
    }

    // --- Preview Panel Logic ---
    function handleGeneratePreview() {
        const ordersByVan = { 'SIN ASIGNAR': [] };

        // Group orders from the main table by their currently assigned van
        ordersTableBody.querySelectorAll('tr').forEach(row => {
            const van = row.querySelector('[data-field="van"]').value;
            const order = {
                number: row.dataset.orderNumber,
                customer: row.cells[1].textContent.trim(),
                address: row.querySelector('[data-field="address"]').value,
                commune: row.querySelector('[data-field="commune"]').value
            };

            if (van) {
                if (!ordersByVan[van]) {
                    ordersByVan[van] = [];
                }
                ordersByVan[van].push(order);
            } else {
                ordersByVan['SIN ASIGNAR'].push(order);
            }
        });

        const actionBar = document.getElementById('preview-action-bar');
        const dashboard = document.getElementById('preview-dashboard');
        dashboard.innerHTML = ''; // Clear previous content

        // Populate the target van dropdown in the action bar
        const moveTargetVanSelect = document.getElementById('move-target-van');
        moveTargetVanSelect.innerHTML = '<option value="">Mover a Furg√≥n...</option>';
        VANS.forEach(van => {
            const option = document.createElement('option');
            option.value = van;
            option.textContent = van;
            moveTargetVanSelect.appendChild(option);
        });
        moveTargetVanSelect.innerHTML += '<option value="--UNASSIGN--">---</option><option value="">Quitar Asignaci√≥n</option>';
        
        actionBar.style.display = 'flex';

        // --- Render Unassigned Panel ---
        const unassignedOrders = ordersByVan['SIN ASIGNAR'];
        const unassignedCommunes = [...new Set(unassignedOrders.map(o => o.commune))].sort();
        
        let unassignedHtml = `
            <div class="unassigned-panel">
                <div class="unassigned-header">
                    <h5>Pedidos Sin Asignar (${unassignedOrders.length})</h5>
                    <div style="margin-left: auto; display: flex; gap: 10px; align-items: center;">
                        <input type="text" id="unassigned-search" onkeyup="handleSearchUnassigned(this)" placeholder="Buscar en no asignados..." style="width: 180px; padding: 6px;">
                        <select id="unassigned-commune-filter" style="width: 150px; padding: 6px;">
                            <option value="">Por Comuna...</option>
                            ${unassignedCommunes.map(c => `<option value="${c}">${c}</option>`).join('')}
                        </select>
                        <button id="select-by-commune-btn" class="action-button" style="padding: 6px 10px; font-size: 12px; background-color: #337ab7;">Seleccionar</button>
                    </div>
                </div>
                <div class="unassigned-list">
                    <ul id="unassigned-orders-ul">`;
        
        if (unassignedOrders.length > 0) {
            unassignedOrders.forEach(order => {
                unassignedHtml += `
                    <li data-commune="${order.commune}" data-search-text="${order.number} ${order.customer} ${order.address} ${order.commune}">
                        <input type="checkbox" class="move-order-checkbox" data-order-number="${order.number}">
                        <span><b>#${order.number}</b> - ${order.customer} - ${order.address}, ${order.commune}</span>
                    </li>`;
            });
        } else {
            unassignedHtml += '<li><small><i>Todos los pedidos han sido asignados.</i></small></li>';
        }
        unassignedHtml += '</ul></div></div>';


        // --- Render Van Columns ---
        const createColumn = (title, orders) => {
            let columnHtml = `<div class="van-column"><h5>${title} (${orders.length})</h5><ul>`;
            if (orders.length > 0) {
                orders.forEach(order => {
                    columnHtml += `
                        <li>
                            <input type="checkbox" class="move-order-checkbox" data-order-number="${order.number}">
                            <span><b>#${order.number}</b> - ${order.customer}<br><small>${order.address}, ${order.commune}</small></span>
                        </li>`;
                });
            }
            columnHtml += '</ul></div>';
            return columnHtml;
        };
        
        const renderRow = (vanList) => {
            const activeVans = vanList.filter(van => ordersByVan[van] && ordersByVan[van].length > 0);
            if (activeVans.length === 0) return ''; // Return nothing if no vans in this row are active

            let rowHtml = '<div class="dashboard-row">';
            activeVans.forEach(van => rowHtml += createColumn(van, ordersByVan[van]));
            rowHtml += '</div>';
            return rowHtml;
        };

        const morningVans = VANS.filter(v => v.includes('Ma√±ana')).sort();
        const afternoonVans = VANS.filter(v => v.includes('Tarde')).sort();
        
        let morningHtml = '<h4>Ma√±ana</h4>' + renderRow(morningVans);
        let afternoonHtml = '<h4 style="margin-top:20px;">Tarde</h4>' + renderRow(afternoonVans);
        
        dashboard.innerHTML = unassignedHtml + morningHtml + afternoonHtml;
    }

    // --- Order Table Logic ---
    function populateTable(orders) {
      ordersTableBody.innerHTML = '';
      orders.forEach(order => {
        const row = ordersTableBody.insertRow();
        row.dataset.orderNumber = order.orderNumber;
        row.innerHTML = `
          <td>${order.orderNumber}</td>
          <td>${order.customerName}</td>
          <td>${order.phone || ''}</td>
          <td><input type="text" class="data-input" data-field="address" value="${order.address || ''}" list="address-list"></td>
          <td><input type="text" class="data-input" data-field="department" value="${order.department || ''}" list="department-list"></td>
          <td><input type="text" class="data-input" data-field="commune" value="${order.commune || ''}" list="commune-list"></td>
          <td>${order.status || ''}</td>
          <td>
            <select class="data-input" data-field="van">
              <option value="">-- Sin Asignar --</option>
              ${VANS.map(v => `<option value="${v}" ${order.van === v ? 'selected' : ''}>${v}</option>`).join('')}
            </select>
          </td>
        `;
      });
    }

    function handleAutoSaveChanges(inputElement) {
      const row = inputElement.closest('tr');
      if (!row) return;

      const orderData = {
          orderNumber: row.dataset.orderNumber,
          phone: row.cells[2].textContent.trim(),
          address: row.querySelector('[data-field="address"]').value,
          department: row.querySelector('[data-field="department"]').value,
          commune: row.querySelector('[data-field="commune"]').value,
          van: row.querySelector('[data-field="van"]').value
      };
      
      statusLog.textContent = `Guardando cambios para el pedido #${orderData.orderNumber}...`;
      
      google.script.run
        .withSuccessHandler(response => {
          statusLog.textContent = response.message;
          setTimeout(() => {
              if (statusLog.textContent === response.message) {
                  statusLog.textContent = 'Listo.';
              }
          }, 3000);
        })
        .withFailureHandler(handleError)
        .saveSingleOrderChange(orderData);
    }

    function handleOrderSearch(event) {
      const searchTerm = event.target.value.toLowerCase();
      const tableRows = ordersTableBody.querySelectorAll('tr');
      tableRows.forEach(row => {
        let rowText = '';
        // Get text from all cells, including the values from inputs/selects
        row.querySelectorAll('td').forEach(cell => {
            const input = cell.querySelector('input, select');
            if (input) {
                rowText += input.value + ' ';
            } else {
                rowText += cell.textContent + ' ';
            }
        });

        if (rowText.toLowerCase().includes(searchTerm)) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      });
    }
    
    // --- RouteXL List Generation ---
    function handleGenerateRouteXLList() {
        const ordersByVan = {};
        ordersTableBody.querySelectorAll('tr').forEach(row => {
            const van = row.querySelector('[data-field="van"]').value;
            if (van) {
                if (!ordersByVan[van]) {
                    ordersByVan[van] = [];
                }
                // Prepend # to make it a clear identifier that matches the backend regex
                const orderNumber = '#' + row.dataset.orderNumber; 
                const address = row.querySelector('[data-field="address"]').value.trim();
                const commune = row.querySelector('[data-field="commune"]').value.trim();
                if (address && commune) {
                    ordersByVan[van].push({
                        orderNumber: orderNumber,
                        addressString: `${address}, ${commune}, Chile`
                    });
                }
            }
        });

        const container = document.getElementById('routexl-output-container');
        container.innerHTML = '';

        const sortedVans = Object.keys(ordersByVan).sort();
        if (sortedVans.length === 0) {
            container.innerHTML = '<p style="font-style: italic;">No hay pedidos con furg√≥n asignado para generar listas.</p>';
            return;
        }

        sortedVans.forEach(van => {
            const orders = ordersByVan[van];
            const accordionItem = document.createElement('div');
            accordionItem.className = 'routexl-accordion-item';

            const header = document.createElement('div');
            header.className = 'routexl-accordion-header';

            const titleSpan = document.createElement('span');
            titleSpan.textContent = `${van} (${orders.length} direcciones)`;

            const copyButton = document.createElement('button');
            copyButton.className = 'action-button copy-van-list-btn';
            copyButton.textContent = 'Copiar Tabla';
            copyButton.style.cssText = 'padding: 5px 10px; font-size: 12px; background-color: #6c757d;';
            
            // Generate the tab-separated value string for the clipboard.
            // This format pastes perfectly into RouteXL's multi-column input.
            const tsvContent = orders.map(o => `${o.orderNumber}\t${o.addressString}`).join('\n');
            copyButton.dataset.copyText = tsvContent;

            header.appendChild(titleSpan);
            header.appendChild(copyButton);

            const content = document.createElement('div');
            content.className = 'routexl-accordion-content';
            content.style.maxHeight = '200px';
            content.style.overflowY = 'auto';

            // Generate the HTML table for display inside the accordion
            let tableHtml = '<table style="font-size: 12px;"><thead><tr><th style="font-weight:bold;">Nombre (N¬∫ Pedido)</th><th style="font-weight:bold;">Direcci√≥n</th></tr></thead><tbody>';
            orders.forEach(o => {
                tableHtml += `<tr><td>${o.orderNumber}</td><td>${o.addressString}</td></tr>`;
            });
            tableHtml += '</tbody></table>';
            content.innerHTML = tableHtml;

            accordionItem.appendChild(header);
            accordionItem.appendChild(content);
            container.appendChild(accordionItem);
        });
    }

    // --- RouteXL and Sheet Generation ---
    function handleProcessRoute() {
      const vanName = document.getElementById('process-van-select').value;
      const text = routeXlInput.value;

      if (!vanName) {
        alert("Por favor, selecciona el furg√≥n que est√°s procesando.");
        return;
      }
      if (!text.trim()) {
        alert("El campo de RouteXL est√° vac√≠o.");
        return;
      }
      setLoadingState(true, `Procesando ruta para ${vanName}...`);
      google.script.run.withSuccessHandler(response => {
        handleSuccess(response);
      }).withFailureHandler(handleError).processRouteXLData(text, vanName);
    }

    function handleCleanup() {
      if (confirm("¬øEst√°s seguro de que quieres eliminar TODAS las hojas de 'Envasado' y 'Ruta' generadas previamente? Esta acci√≥n no se puede deshacer.")) {
        setLoadingState(true, 'Eliminando hojas antiguas...');
        google.script.run
          .withSuccessHandler(response => {
            // Use the generic handleSuccess, which will just alert the message.
            handleSuccess(response.message);
          })
          .withFailureHandler(handleError)
          .cleanupRouteSheets();
      }
    }
  </script>

  <!-- Error Modal -->
  <div id="error-modal" class="error-modal">
    <div class="error-modal-content">
      <h3>Ocurri√≥ un Error</h3>
      <pre id="error-message-content"></pre>
      <div class="error-modal-footer">
          <button id="copy-error-btn" class="action-button" style="background-color:#5bc0de;">Copiar Error</button>
          <button id="close-error-btn" class="action-button" style="background-color:#6c757d;">Cerrar</button>
      </div>
    </div>
  </div>
</body>
</html>
