<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: #f0f2f5; color: #333; }
    .container { padding: 20px; }
    h1, h2 { color: #1c1e21; }
    .card { background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 8px; text-align: left; border-bottom: 1px solid #eee; }
    th { font-weight: bold; font-size: 12px; color: #606770; }
    td { font-size: 14px; }
    input, select, textarea { width: 100%; padding: 6px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
    .action-button {
      padding: 12px 18px; font-size: 14px; font-weight: bold; border-radius: 5px;
      border: none; cursor: pointer; transition: background-color 0.2s; color: white; margin-right: 10px;
    }
    .action-button:disabled { background-color: #dcdfe3 !important; color: #bec3c9 !important; cursor: not-allowed;}
    #load-btn { background-color: #0d6efd; }
    #save-btn { background-color: #198754; }
    #process-btn { background-color: #ffc107; color: black; }
    #generate-btn { background-color: #6f42c1; }
    #status-log { font-size: 12px; font-style: italic; color: #606770; margin-top: 15px; min-height: 18px;}
    .textarea-container { width: 100%; }
    #routexl-input { height: 150px; font-family: monospace; }
    
    /* Layout del dashboard */
    .dashboard-row { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 15px; align-items: flex-start; }
    .van-column { flex: 0 0 300px; background-color: #f9f9f9; border-radius: 6px; border: 1px solid #ddd; }
    .van-column h5 { margin: 0; padding: 10px; background-color: #e9ecef; border-bottom: 1px solid #ddd; border-radius: 6px 6px 0 0; }
    .van-column ul { list-style-type: none; padding: 0; margin: 0; min-height: 50px; }

    /* FILAS UNIFICADAS CON GRID (checkbox en columna fija) */
    .preview-list { list-style: none; margin: 0; padding: 10px; }
    .preview-item {
      display: grid;
      grid-template-columns: 26px 1fr; /* Columna fija para checkbox */
      column-gap: 8px;
      align-items: start;
      padding: 8px 6px;
      border-bottom: 1px solid #eee;
      background: #fff;
      min-width: 0; /* permite ellipsis en la segunda columna */
    }
    .preview-item:last-child { border-bottom: none; }
    .preview-item:hover { background: #fafafa; }
    .move-order-checkbox {
      width: 18px; height: 18px; margin: 0;
      align-self: start;
    }
    /* UNA SOLA L√çNEA + ELIPSIS */
    .order-text {
      line-height: 1.2;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      display: block;
    }

    /* Panel de no asignados */
    .unassigned-panel { border: 2px solid #dc3545; border-radius: 6px; background-color: #fff; margin-bottom: 20px; }
    .unassigned-header { padding: 10px; background-color: #f8d7da; border-bottom: 2px solid #dc3545; display: flex; gap: 10px; align-items: center; }
    .unassigned-header h5 { color: #721c24; margin: 0; }
    .unassigned-list { max-height: 250px; overflow-y: auto; }

    /* Acorde√≥n RouteXL */
    .routexl-accordion-header { display: flex; justify-content: space-between; align-items: center; padding: 10px; background-color: #f7f7f7; border: 1px solid #ddd; cursor: pointer; font-weight: bold; }
    .routexl-accordion-header:hover { background-color: #e9e9e9; }
    .routexl-accordion-content { display: none; padding: 10px; border: 1px solid #ddd; border-top: none; }

    /* Modal de error */
    .error-modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
    .error-modal-content { background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 700px; border-radius: 8px; box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2); }
    .error-modal-content h3 { color: #c00; margin-top: 0; }
    .error-modal-content pre { white-space: pre-wrap; word-wrap: break-word; background-color: #f3f3f3; padding: 15px; border: 1px solid #ccc; max-height: 250px; overflow-y: auto; }
    .error-modal-footer { text-align: right; margin-top: 15px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üöö Comanda Rutas</h1>

    <div class="card">
      <h2>Paso 1: Formatear Direcciones y Asignar Furg√≥n</h2>
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; gap: 10px;">
        <input type="text" id="order-search-input" placeholder="Buscar en tabla..." style="flex-grow: 1; padding: 8px;">
        <select id="commune-filter-select" style="width: 200px; padding: 8px;">
          <option value="">Filtrar por Comuna</option>
        </select>
        <select id="bulk-van-select" style="width: 200px; padding: 8px;">
          <option value="">Asignar Furg√≥n...</option>
        </select>
        <button id="bulk-assign-btn" class="action-button" style="background-color: #5bc0de; flex-shrink: 0;">Asignar</button>
      </div>
      <div id="status-log">Cargando pedidos...</div>
      <div style="max-height: 400px; overflow-y: auto; margin-top: 15px;">
        <table id="orders-table">
          <thead>
            <tr>
              <th>N¬∫ Pedido</th>
              <th>Cliente</th>
              <th>Tel√©fono</th>
              <th>Direcci√≥n</th>
              <th>Depto.</th>
              <th>Comuna</th>
              <th>Estado</th>
              <th>Furg√≥n</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="card">
        <h2>Paso 1.75: Previsualizaci√≥n y Ajustes Finales</h2>
        <p>Genera una vista previa de los pedidos agrupados por furg√≥n. Aqu√≠ puedes realizar ajustes de √∫ltima hora antes de generar la lista para RouteXL.</p>
        <div>
            <button id="generate-preview-btn" class="action-button" style="background-color: #6610f2;">Generar/Actualizar Previsualizaci√≥n</button>
        </div>
        <div id="preview-panel" style="margin-top: 15px;">
            <div id="preview-action-bar" style="padding-bottom: 15px; border-bottom: 1px solid #ccc; margin-bottom: 15px; display: none; gap: 10px; align-items: center;">
                <label for="move-target-van" style="font-weight: bold;">Mover a:</label>
                <select id="move-target-van" style="width: 200px; padding: 8px;"></select>
                <button id="move-selected-btn" class="action-button" style="background-color: #f0ad4e;">Mover Seleccionados</button>
            </div>
            <div id="preview-dashboard"></div>
        </div>
    </div>

    <div class="card">
      <h2>Paso 1.5: Generar Listas para RouteXL</h2>
      <p>Genera las listas de direcciones por furg√≥n para pegar en RouteXL. Solo se incluir√°n los pedidos que tengan un furg√≥n asignado.</p>
      <div>
        <button id="generate-list-btn" class="action-button" style="background-color: #0d6efd;">Generar Listas</button>
      </div>
      <div id="routexl-output-container" style="margin-top: 15px;"></div>
    </div>

    <div class="card">
      <h2>Paso 2: Procesar Orden de RouteXL</h2>
      <p>Selecciona el furg√≥n correspondiente y pega aqu√≠ el texto copiado desde RouteXL para ordenar los pedidos.</p>
      <div class="textarea-container">
        <textarea id="routexl-input" placeholder="Pega aqu√≠ el contenido de RouteXL..."></textarea>
      </div>
      <div style="margin-top: 10px; display: flex; align-items: center; gap: 10px;">
        <select id="process-van-select" style="padding: 12px; border-radius: 5px; border: 1px solid #ccc;">
          <option value="">-- Seleccionar Furg√≥n --</option>
        </select>
        <button id="process-btn" class="action-button">Procesar Ruta</button>
      </div>
    </div>

    <div id="results-card" class="card" style="display:none; text-align: center;">
      <h2>Resultados de la Ruta</h2>
      <p id="results-message" style="margin-bottom: 15px;"></p>
      <div id="pdf-links-container"></div>
    </div>

    <div class="card">
      <h2>Mantenimiento</h2>
      <p>Usa este bot√≥n para eliminar todas las hojas de 'Envasado' y 'Ruta' que ya no necesites.</p>
      <div>
        <button id="cleanup-btn" class="action-button" style="background-color: #d9534f;">üóëÔ∏è Limpiar Hojas de Ruta Antiguas</button>
      </div>
    </div>

  </div>

  <datalist id="address-list"></datalist>
  <datalist id="department-list"></datalist>
  <datalist id="commune-list"></datalist>

  <script>
    // DOM
    const statusLog = document.getElementById('status-log');
    const processBtn = document.getElementById('process-btn');
    const generateBtn = document.getElementById('generate-btn');
    const ordersTableBody = document.querySelector("#orders-table tbody");
    const routeXlInput = document.getElementById('routexl-input');
    const generatePreviewBtn = document.getElementById('generate-preview-btn');
    const previewPanel = document.getElementById('preview-panel');
    const generateListBtn = document.getElementById('generate-list-btn');

    // State
    const VANS = [
      'Furgon 1 Ma√±ana','Furgon 1 Tarde',
      'Furgon 2 Ma√±ana','Furgon 2 Tarde',
      'Furgon 3 Ma√±ana','Furgon 3 Tarde',
      'Furgon 4 Ma√±ana','Furgon 4 Tarde'
    ];

    // Init
    document.addEventListener('DOMContentLoaded', () => {
      loadInitialData();
      addEventListeners();
      populateBulkVanSelector();
      populateProcessVanSelector();
    });

    function populateBulkVanSelector() {
      const bulkVanSelect = document.getElementById('bulk-van-select');
      VANS.forEach(v => { const o=document.createElement('option'); o.value=v; o.textContent=v; bulkVanSelect.appendChild(o); });
    }
    function populateProcessVanSelector() {
      const sel = document.getElementById('process-van-select');
      VANS.forEach(v => { const o=document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o); });
    }

    function addEventListeners() {
      ordersTableBody.addEventListener('change', (e) => {
        if (e.target.classList.contains('data-input')) handleAutoSaveChanges(e.target);
      });
      processBtn.addEventListener('click', handleProcessRoute);
      generateListBtn.addEventListener('click', handleGenerateRouteXLList);
      generatePreviewBtn.addEventListener('click', handleGeneratePreview);
      document.getElementById('cleanup-btn').addEventListener('click', handleCleanup);
      document.getElementById('order-search-input').addEventListener('keyup', handleOrderSearch);
      document.getElementById('commune-filter-select').addEventListener('change', handleCommuneFilter);
      document.getElementById('bulk-assign-btn').addEventListener('click', handleBulkAssign);
      document.getElementById('move-selected-btn').addEventListener('click', handleMoveSelectedOrders);

      // Acorde√≥n RouteXL
      document.getElementById('routexl-output-container').addEventListener('click', function(e) {
        const header = e.target.closest('.routexl-accordion-header');
        if (e.target.classList.contains('copy-van-list-btn')) {
          const txt = e.target.dataset.copyText;
          if (txt) navigator.clipboard.writeText(txt).then(()=>alert('¬°Lista copiada al portapapeles!')).catch(()=>alert('Error al copiar la lista.'));
          return;
        }
        if (header) {
          const content = header.nextElementSibling;
          if (content && content.classList.contains('routexl-accordion-content')) {
            const show = content.style.display === 'block';
            content.style.display = show ? 'none' : 'block';
          }
        }
      });

      // Bot√≥n din√°mico "Seleccionar por Comuna"
      previewPanel.addEventListener('click', (e) => {
        if (e.target && e.target.id === 'select-by-commune-btn') handleSelectUnassignedByCommune();
      });

      // Modal error
      document.getElementById('close-error-btn').addEventListener('click', () => {
        document.getElementById('error-modal').style.display = 'none';
      });
      document.getElementById('copy-error-btn').addEventListener('click', () => {
        const msg = document.getElementById('error-message-content').textContent;
        navigator.clipboard.writeText(msg).then(()=>{
          const btn = document.getElementById('copy-error-btn');
          btn.textContent='¬°Copiado!'; setTimeout(()=>btn.textContent='Copiar Error',2000);
        }).catch(()=>alert('No se pudo copiar el error.'));
      });
    }

    function handleSearchUnassigned(input) {
      const term = input.value.toLowerCase();
      document.querySelectorAll('#unassigned-orders-ul li').forEach(li => {
        const text = li.dataset.searchText.toLowerCase();
        li.style.display = text.includes(term) ? 'grid' : 'none';
      });
    }

    function handleSelectUnassignedByCommune() {
      const c = document.getElementById('unassigned-commune-filter').value;
      if (!c) { alert('Por favor, selecciona una comuna del filtro.'); return; }
      let found = 0;
      document.querySelectorAll('#unassigned-orders-ul li').forEach(li => {
        if (li.style.display !== 'none' && li.dataset.commune === c) {
          const cb = li.querySelector('.move-order-checkbox'); if (cb) { cb.checked = true; found++; }
        }
      });
      if (found === 0) alert('No se encontraron pedidos visibles para la comuna seleccionada.');
    }

    function handleMoveSelectedOrders() {
      const targetVan = document.getElementById('move-target-van').value;
      if (targetVan === '--UNASSIGN--') return;
      const checks = document.querySelectorAll('.move-order-checkbox:checked');
      if (checks.length === 0) { alert('Selecciona al menos un pedido.'); return; }

      let moved = 0;
      checks.forEach(cb => {
        const num = cb.dataset.orderNumber;
        const row = ordersTableBody.querySelector(`tr[data-order-number="${num}"]`);
        if (row) {
          const sel = row.querySelector('select[data-field="van"]');
          if (sel.value !== targetVan) { sel.value = targetVan; sel.dispatchEvent(new Event('change',{bubbles:true})); moved++; }
        }
      });
      if (moved > 0) {
        statusLog.textContent = 'Actualizando vista...';
        setTimeout(()=>{ handleGeneratePreview(); statusLog.textContent = `${moved} pedido(s) movido(s).`; }, 800);
      } else {
        alert('No se realizaron cambios.');
      }
    }

    function handleCommuneFilter(e) {
      const c = e.target.value;
      ordersTableBody.querySelectorAll('tr').forEach(row => {
        const inp = row.cells[5].querySelector('input');
        if (inp) row.style.display = (c === "" || inp.value === c) ? '' : 'none';
      });
    }
    
    // Gen√©ricos
    function setLoadingState(isLoading, message='') {
      statusLog.textContent = message;
      document.querySelectorAll('.action-button').forEach(btn => { if(btn.id!=='copy-list-btn') btn.disabled = isLoading; });
    }
    function handleSuccess(r) {
      setLoadingState(false);
      if (r && r.status==='success' && r.packagingPdfUrl) showPdfLinks(r);
      else if (r && r.message) alert(r.message);
      else if (typeof r === 'string') alert(r);
      else alert('Operaci√≥n completada.');
    }
    function showPdfLinks(r) {
      document.getElementById('results-message').textContent = r.message;
      document.getElementById('pdf-links-container').innerHTML = `
        <a href="${r.packagingPdfUrl}" target="_blank" class="action-button" style="background-color:#5cb85c; margin-bottom:10px; display:inline-block; width:80%; max-width:400px;">Imprimir/Descargar PDF de Envasado (Vertical)</a><br>
        <a href="${r.routePdfUrl}" target="_blank" class="action-button" style="background-color:#337ab7; display:inline-block; width:80%; max-width:400px;">Imprimir/Descargar PDF de Ruta (Horizontal)</a>`;
      document.getElementById('results-card').style.display = 'block';
      statusLog.textContent = 'Proceso completado. Los enlaces para imprimir est√°n listos.';
    }
    function handleError(error) {
      setLoadingState(false, `Error: ${error.message}`);
      document.getElementById('error-message-content').textContent = error.message;
      document.getElementById('error-modal').style.display = 'block';
    }
    
    // Data y tabla
    function loadInitialData() {
      setLoadingState(true, 'Cargando datos iniciales...');
      google.script.run.withSuccessHandler(populateOrdersTable).withFailureHandler(handleError).getOrdersForRouting();
    }
    function populateOrdersTable(orders) {
      populateDatalists(orders);
      populateTable(orders);
      setLoadingState(false, `Se cargaron ${orders.length} pedidos √∫nicos.`);
    }
    function populateDatalists(orders) {
      const a=new Set(), d=new Set(), c=new Set();
      orders.forEach(o=>{ if(o.address)a.add(o.address); if(o.department)d.add(o.department); if(o.commune)c.add(o.commune); });
      const esc=s=>String(s||'').replace(/"/g,'&quot;');
      document.getElementById('address-list').innerHTML=[...a].map(v=>`<option value="${esc(v)}"></option>`).join('');
      document.getElementById('department-list').innerHTML=[...d].map(v=>`<option value="${esc(v)}"></option>`).join('');
      document.getElementById('commune-list').innerHTML=[...c].map(v=>`<option value="${esc(v)}"></option>`).join('');
      const sel=document.getElementById('commune-filter-select');
      sel.innerHTML='<option value="">Filtrar por Comuna</option>';
      [...c].sort().forEach(cm=>{ const o=document.createElement('option'); o.value=cm; o.textContent=cm; sel.appendChild(o); });
    }
    function handleBulkAssign() {
      const cm = document.getElementById('commune-filter-select').value;
      const v = document.getElementById('bulk-van-select').value;
      if (!cm) { alert('Primero filtra por una comuna.'); return; }
      if (!v) { alert('Selecciona un furg√≥n.'); return; }
      const updated=[], rows=ordersTableBody.querySelectorAll('tr'); let n=0;
      rows.forEach(r=>{
        if (r.style.display==='none') return;
        const ci=r.querySelector('[data-field="commune"]');
        if (ci && ci.value===cm) {
          const vs=r.querySelector('[data-field="van"]');
          if (vs) { vs.value=v; n++; updated.push({
            orderNumber:r.dataset.orderNumber,
            phone:r.cells[2].textContent.trim(),
            address:r.querySelector('[data-field="address"]').value,
            department:r.querySelector('[data-field="department"]').value,
            commune:ci.value, van:vs.value
          });}
        }
      });
      if (n>0) {
        statusLog.textContent=`Asignando furg√≥n a ${n} pedidos...`;
        google.script.run.withSuccessHandler(()=>{
          alert(`${n} pedidos de "${cm}" asignados a "${v}". Cambios guardados.`);
          statusLog.textContent='Asignaci√≥n masiva completada.';
        }).withFailureHandler(handleError).saveRouteChanges(updated);
      } else { alert('No hay pedidos visibles para esa comuna.'); }
    }

    // Previsualizaci√≥n
    function handleGeneratePreview() {
      const ordersByVan = { 'SIN ASIGNAR': [] };
      ordersTableBody.querySelectorAll('tr').forEach(row => {
        const van = row.querySelector('[data-field="van"]').value;
        const order = {
          number: row.dataset.orderNumber,
          customer: row.cells[1].textContent.trim(),
          address: row.querySelector('[data-field="address"]').value,
          commune: row.querySelector('[data-field="commune"]').value
        };
        if (van) { (ordersByVan[van] ||= []).push(order); }
        else { ordersByVan['SIN ASIGNAR'].push(order); }
      });

      const actionBar = document.getElementById('preview-action-bar');
      const dashboard = document.getElementById('preview-dashboard');
      dashboard.innerHTML = '';

      const moveTargetVanSelect = document.getElementById('move-target-van');
      moveTargetVanSelect.innerHTML = '<option value="">Mover a Furg√≥n...</option>';
      VANS.forEach(v => { const o=document.createElement('option'); o.value=v; o.textContent=v; moveTargetVanSelect.appendChild(o); });
      moveTargetVanSelect.innerHTML += '<option value="--UNASSIGN--">---</option><option value="">Quitar Asignaci√≥n</option>';
      actionBar.style.display = 'flex';

      // SIN ASIGNAR
      const ua = ordersByVan['SIN ASIGNAR'];
      const communes = [...new Set(ua.map(o=>o.commune))].sort();
      let unassignedHtml = `
        <div class="unassigned-panel">
          <div class="unassigned-header">
            <h5>Pedidos Sin Asignar (${ua.length})</h5>
            <div style="margin-left:auto; display:flex; gap:10px; align-items:center;">
              <input type="text" id="unassigned-search" onkeyup="handleSearchUnassigned(this)" placeholder="Buscar en no asignados..." style="width:180px; padding:6px;">
              <select id="unassigned-commune-filter" style="width:150px; padding:6px;">
                <option value="">Por Comuna...</option>
                ${communes.map(c=>`<option value="${c}">${c}</option>`).join('')}
              </select>
              <button id="select-by-commune-btn" class="action-button" style="padding:6px 10px; font-size:12px; background-color:#337ab7;">Seleccionar</button>
            </div>
          </div>
          <div class="unassigned-list">
            <ul id="unassigned-orders-ul" class="preview-list">`;
      if (ua.length>0) {
        ua.forEach(o => {
          const full = `#${o.number} - ${o.customer}, ${o.address}, ${o.commune}`;
          unassignedHtml += `
            <li class="preview-item" data-commune="${o.commune}" data-search-text="${full}">
              <input type="checkbox" class="move-order-checkbox" data-order-number="${o.number}">
              <span class="order-text" title="${full}"><b>#${o.number}</b> - ${o.customer}, ${o.address}, ${o.commune}</span>
            </li>`;
        });
      } else {
        unassignedHtml += `<li class="preview-item"><span class="order-text"><small><i>Todos los pedidos han sido asignados.</i></small></span></li>`;
      }
      unassignedHtml += `</ul></div></div>`;

      // Columnas por furg√≥n
      const createColumn = (title, list) => {
        let html = `<div class="van-column"><h5>${title} (${list.length})</h5><ul class="preview-list">`;
        list.forEach(o => {
          const full = `#${o.number} - ${o.customer}, ${o.address}, ${o.commune}`;
          html += `
            <li class="preview-item">
              <input type="checkbox" class="move-order-checkbox" data-order-number="${o.number}">
              <span class="order-text" title="${full}"><b>#${o.number}</b> - ${o.customer}, ${o.address}, ${o.commune}</span>
            </li>`;
        });
        html += `</ul></div>`;
        return html;
      };
      const renderRow = (vans) => {
        const active = vans.filter(v => ordersByVan[v] && ordersByVan[v].length>0);
        if (active.length===0) return '';
        let row = '<div class="dashboard-row">';
        active.forEach(v => row += createColumn(v, ordersByVan[v]));
        row += '</div>';
        return row;
      };
      const morning = VANS.filter(v=>v.includes('Ma√±ana')).sort();
      const afternoon = VANS.filter(v=>v.includes('Tarde')).sort();
      dashboard.innerHTML = unassignedHtml + '<h4>Ma√±ana</h4>' + renderRow(morning) + '<h4 style="margin-top:20px;">Tarde</h4>' + renderRow(afternoon);
    }

    // Tabla principal
    function populateTable(orders) {
      ordersTableBody.innerHTML = '';
      orders.forEach(o => {
        const row = ordersTableBody.insertRow();
        row.dataset.orderNumber = o.orderNumber;
        row.innerHTML = `
          <td>${o.orderNumber}</td>
          <td>${o.customerName}</td>
          <td>${o.phone || ''}</td>
          <td><input type="text" class="data-input" data-field="address" value="${o.address || ''}" list="address-list"></td>
          <td><input type="text" class="data-input" data-field="department" value="${o.department || ''}" list="department-list"></td>
          <td><input type="text" class="data-input" data-field="commune" value="${o.commune || ''}" list="commune-list"></td>
          <td>${o.status || ''}</td>
          <td>
            <select class="data-input" data-field="van">
              <option value="">-- Sin Asignar --</option>
              ${VANS.map(v => `<option value="${v}" ${o.van===v?'selected':''}>${v}</option>`).join('')}
            </select>
          </td>`;
      });
    }

    function handleAutoSaveChanges(el) {
      const row = el.closest('tr'); if(!row) return;
      const data = {
        orderNumber: row.dataset.orderNumber,
        phone: row.cells[2].textContent.trim(),
        address: row.querySelector('[data-field="address"]').value,
        department: row.querySelector('[data-field="department"]').value,
        commune: row.querySelector('[data-field="commune"]').value,
        van: row.querySelector('[data-field="van"]').value
      };
      statusLog.textContent = `Guardando cambios para el pedido #${data.orderNumber}...`;
      google.script.run.withSuccessHandler(resp=>{
        statusLog.textContent = resp.message;
        setTimeout(()=>{ if(statusLog.textContent===resp.message) statusLog.textContent='Listo.'; },3000);
      }).withFailureHandler(handleError).saveSingleOrderChange(data);
    }

    function handleOrderSearch(e) {
      const term = e.target.value.toLowerCase();
      ordersTableBody.querySelectorAll('tr').forEach(row => {
        let t=''; row.querySelectorAll('td').forEach(c=>{
          const i=c.querySelector('input, select'); t += (i? i.value : c.textContent) + ' ';
        });
        row.style.display = t.toLowerCase().includes(term) ? '' : 'none';
      });
    }

    // Listas RouteXL
    function handleGenerateRouteXLList() {
      const byVan = {};
      ordersTableBody.querySelectorAll('tr').forEach(r => {
        const van = r.querySelector('[data-field="van"]').value;
        if (!van) return;
        (byVan[van] ||= []);
        const orderNumber = '#' + r.dataset.orderNumber;
        const address = r.querySelector('[data-field="address"]').value.trim();
        const commune = r.querySelector('[data-field="commune"]').value.trim();
        if (address && commune) byVan[van].push({ orderNumber, addressString: `${address}, ${commune}, Chile` });
      });
      const container = document.getElementById('routexl-output-container');
      container.innerHTML = '';
      const vans = Object.keys(byVan).sort();
      if (vans.length===0) { container.innerHTML = '<p style="font-style: italic;">No hay pedidos con furg√≥n asignado para generar listas.</p>'; return; }
      vans.forEach(van => {
        const orders = byVan[van];
        const item = document.createElement('div'); item.className='routexl-accordion-item';
        const header = document.createElement('div'); header.className='routexl-accordion-header';
        const title = document.createElement('span'); title.textContent = `${van} (${orders.length} direcciones)`;
        const btn = document.createElement('button'); btn.className='action-button copy-van-list-btn'; btn.textContent='Copiar Tabla'; btn.style.cssText='padding:5px 10px; font-size:12px; background-color:#6c757d;';
        btn.dataset.copyText = orders.map(o => `${o.orderNumber}\t${o.addressString}`).join('\n');
        header.appendChild(title); header.appendChild(btn);
        const content = document.createElement('div'); content.className='routexl-accordion-content'; content.style.maxHeight='200px'; content.style.overflowY='auto';
        let html = '<table style="font-size: 12px;"><thead><tr><th style="font-weight:bold;">Nombre (N¬∫ Pedido)</th><th style="font-weight:bold;">Direcci√≥n</th></tr></thead><tbody>';
        orders.forEach(o=>{ html += `<tr><td>${o.orderNumber}</td><td>${o.addressString}</td></tr>`; });
        html += '</tbody></table>'; content.innerHTML = html;
        item.appendChild(header); item.appendChild(content); container.appendChild(item);
      });
    }

    // Procesamiento y limpieza
    function handleProcessRoute() {
      const vanName = document.getElementById('process-van-select').value;
      const text = routeXlInput.value;
      if (!vanName) { alert("Selecciona el furg√≥n."); return; }
      if (!text.trim()) { alert("El campo de RouteXL est√° vac√≠o."); return; }
      setLoadingState(true, `Procesando ruta para ${vanName}...`);
      google.script.run.withSuccessHandler(handleSuccess).withFailureHandler(handleError).processRouteXLData(text, vanName);
    }
    function handleCleanup() {
      if (!confirm("¬øEliminar TODAS las hojas de 'Envasado' y 'Ruta' generadas previamente?")) return;
      setLoadingState(true, 'Eliminando hojas antiguas...');
      google.script.run.withSuccessHandler(r=>{ handleSuccess(r.message); }).withFailureHandler(handleError).cleanupRouteSheets();
    }
  </script>

  <!-- Modal de Error -->
  <div id="error-modal" class="error-modal">
    <div class="error-modal-content">
      <h3>Ocurri√≥ un Error</h3>
      <pre id="error-message-content"></pre>
      <div class="error-modal-footer">
        <button id="copy-error-btn" class="action-button" style="background-color:#5bc0de;">Copiar Error</button>
        <button id="close-error-btn" class="action-button" style="background-color:#6c757d;">Cerrar</button>
      </div>
    </div>
  </div>
</body>
</html>
