<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: #f0f2f5; color: #333; }
    .container { padding: 20px; }
    h1, h2 { color: #1c1e21; }
    .card { background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 8px; text-align: left; border-bottom: 1px solid #eee; }
    th { font-weight: bold; font-size: 12px; color: #606770; }
    td { font-size: 14px; }
    input, select, textarea { width: 100%; padding: 6px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }

    .action-button {
      padding: 12px 18px; font-size: 14px; font-weight: bold; border-radius: 5px;
      border: none; cursor: pointer; transition: background-color 0.2s; color: white; margin-right: 10px;
    }
    .action-button.sm { padding: 6px 10px; font-size: 12px; }
    .action-button:disabled { background-color: #dcdfe3 !important; color: #bec3c9 !important; cursor: not-allowed;}
    #status-log { font-size: 12px; font-style: italic; color: #606770; margin-top: 15px; min-height: 18px;}

    /* ===== Preview: listas compactas y alineadas ===== */
    .preview-list { list-style: none; margin: 0; padding: 10px; }
    .preview-item {
      display: grid;
      grid-template-columns: 26px 1fr; /* columna fija para el checkbox */
      column-gap: 8px;
      align-items: start;
      padding: 8px 6px;
      border-bottom: 1px solid #eee;
      background: #fff;
      min-width: 0; /* permite ellipsis */
    }
    .preview-item:last-child { border-bottom: none; }
    .preview-item:hover { background: #fafafa; }

    .move-order-checkbox {
      width: 18px; height: 18px; margin: 0; align-self: start;
    }
    .order-text {
      line-height: 1.2;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      display: block;
    }

    /* ===== Acordeones por furg√≥n ===== */
    .van-accordion { border: 1px solid #ddd; border-radius: 6px; background: #fff; margin-bottom: 12px; }
    .van-accordion-header {
      display: flex; align-items: center; gap: 10px;
      padding: 10px; background: #f7f7f7; border-bottom: 1px solid #ddd; cursor: pointer; user-select: none;
    }
    .van-accordion-header h5 { margin: 0; font-size: 14px; font-weight: 700; color: #333; flex: 1; }
    .van-accordion-header .badge { font-size: 11px; background: #e9ecef; padding: 3px 8px; border-radius: 999px; color: #333; }
    .van-accordion-actions { display: flex; gap: 8px; align-items: center; }
    .van-accordion-content { display: none; }
    .van-accordion-content-inner { max-height: 260px; overflow-y: auto; }

    /* Panel SIN ASIGNAR destacado */
    .unassigned .van-accordion-header { background: #f8d7da; border-bottom-color: #dc3545; }
    .unassigned .van-accordion { border-color: #dc3545; }
    .unassigned .van-accordion-header h5 { color: #721c24; }

    /* Acorde√≥n RouteXL (se mantiene) */
    .routexl-accordion-header { display: flex; justify-content: space-between; align-items: center; padding: 10px; background-color: #f7f7f7; border: 1px solid #ddd; cursor: pointer; font-weight: bold; }
    .routexl-accordion-header:hover { background-color: #e9e9e9; }
    .routexl-accordion-content { display: none; padding: 10px; border: 1px solid #ddd; border-top: none; }

    /* Modal de error */
    .error-modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
    .error-modal-content { background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 700px; border-radius: 8px; box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2); }
    .error-modal-content h3 { color: #c00; margin-top: 0; }
    .error-modal-content pre { white-space: pre-wrap; word-wrap: break-word; background-color: #f3f3f3; padding: 15px; border: 1px solid #ccc; max-height: 250px; overflow-y: auto; }
    .error-modal-footer { text-align: right; margin-top: 15px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üöö Comanda Rutas</h1>

    <!-- Paso 1 -->
    <div class="card">
      <h2>Paso 1: Formatear Direcciones y Asignar Furg√≥n</h2>
      <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px;">
        <input type="text" id="order-search-input" placeholder="Buscar en tabla..." style="flex:1; padding:8px;">
        <select id="commune-filter-select" style="width: 200px; padding: 8px;">
          <option value="">Filtrar por Comuna</option>
        </select>
        <select id="bulk-van-select" style="width: 200px; padding: 8px;">
          <option value="">Asignar Furg√≥n...</option>
        </select>
        <button id="bulk-assign-btn" class="action-button" style="background:#5bc0de;">Asignar</button>
      </div>
      <div id="status-log">Cargando pedidos...</div>
      <div style="max-height: 400px; overflow-y: auto; margin-top: 15px;">
        <table id="orders-table">
          <thead>
            <tr>
              <th>N¬∫ Pedido</th><th>Cliente</th><th>Tel√©fono</th><th>Direcci√≥n</th>
              <th>Depto.</th><th>Comuna</th><th>Estado</th><th>Furg√≥n</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Paso 1.75 -->
    <div class="card">
      <h2>Paso 1.75: Previsualizaci√≥n y Ajustes Finales</h2>
      <p>Abre un furg√≥n para ver sus pedidos. Selecciona y usa ‚ÄúMover seleccionados‚Äù para traspasar clientes de un furg√≥n a otro.</p>
      <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px;">
        <button id="generate-preview-btn" class="action-button" style="background:#6610f2;">Generar/Actualizar Previsualizaci√≥n</button>
      </div>

      <div id="preview-panel" style="margin-top:15px;">
        <div id="preview-action-bar" style="padding:10px; border:1px solid #ddd; border-radius:6px; margin-bottom:12px; display:none; align-items:center; gap:10px;">
          <label for="move-target-van" style="font-weight:700;">Mover seleccionados a:</label>
          <select id="move-target-van" style="width: 220px; padding: 8px;"></select>
          <button id="move-selected-btn" class="action-button" style="background:#f0ad4e;">Mover Seleccionados</button>
          <div style="margin-left:auto; display:flex; gap:8px;">
            <button id="expand-all-btn" class="action-button sm" style="background:#6c757d;">Expandir todo</button>
            <button id="collapse-all-btn" class="action-button sm" style="background:#6c757d;">Colapsar todo</button>
          </div>
        </div>
        <div id="preview-accordions"><!-- acordeones por furg√≥n aqu√≠ --></div>
      </div>
    </div>

    <!-- Paso 1.5 -->
    <div class="card">
      <h2>Paso 1.5: Generar Listas para RouteXL</h2>
      <p>Solo se incluyen pedidos con furg√≥n asignado.</p>
      <div><button id="generate-list-btn" class="action-button" style="background:#0d6efd;">Generar Listas</button></div>
      <div id="routexl-output-container" style="margin-top: 15px;"></div>
    </div>

    <!-- Paso 2 -->
    <div class="card">
      <h2>Paso 2: Procesar Orden de RouteXL</h2>
      <div class="textarea-container"><textarea id="routexl-input" placeholder="Pega aqu√≠ el contenido de RouteXL..." style="height:150px; font-family:monospace;"></textarea></div>
      <div style="margin-top:10px; display:flex; gap:10px; align-items:center;">
        <select id="process-van-select" style="padding:12px; border-radius:5px; border:1px solid #ccc;">
          <option value="">-- Seleccionar Furg√≥n --</option>
        </select>
        <button id="process-btn" class="action-button" style="background:#ffc107; color:#000;">Procesar Ruta</button>
      </div>
    </div>

    <!-- Resultados -->
    <div id="results-card" class="card" style="display:none; text-align:center;">
      <h2>Resultados de la Ruta</h2>
      <p id="results-message" style="margin-bottom: 15px;"></p>
      <div id="pdf-links-container"></div>
    </div>

    <!-- Mantenimiento -->
    <div class="card">
      <h2>Mantenimiento</h2>
      <button id="cleanup-btn" class="action-button" style="background:#d9534f;">üóëÔ∏è Limpiar Hojas de Ruta Antiguas</button>
    </div>
  </div>

  <datalist id="address-list"></datalist>
  <datalist id="department-list"></datalist>
  <datalist id="commune-list"></datalist>

  <script>
    // ====== DOM ======
    const statusLog = document.getElementById('status-log');
    const ordersTableBody = document.querySelector("#orders-table tbody");
    const routeXlInput = document.getElementById('routexl-input');
    const generatePreviewBtn = document.getElementById('generate-preview-btn');
    const previewPanel = document.getElementById('preview-panel');
    const previewAccordions = document.getElementById('preview-accordions');
    const generateListBtn = document.getElementById('generate-list-btn');

    // ====== STATE ======
    const VANS = [
      'Furgon 1 Ma√±ana','Furgon 1 Tarde',
      'Furgon 2 Ma√±ana','Furgon 2 Tarde',
      'Furgon 3 Ma√±ana','Furgon 3 Tarde',
      'Furgon 4 Ma√±ana','Furgon 4 Tarde'
    ];

    document.addEventListener('DOMContentLoaded', () => {
      loadInitialData();
      addEventListeners();
      populateBulkVanSelector();
      populateProcessVanSelector();
    });

    function populateBulkVanSelector() {
      const sel = document.getElementById('bulk-van-select');
      VANS.forEach(v => { const o=document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o); });
    }
    function populateProcessVanSelector() {
      const sel = document.getElementById('process-van-select');
      VANS.forEach(v => { const o=document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o); });
    }

    function addEventListeners() {
      // tabla principal
      ordersTableBody.addEventListener('change', (e) => {
        if (e.target.classList.contains('data-input')) handleAutoSaveChanges(e.target);
      });
      document.getElementById('order-search-input').addEventListener('keyup', handleOrderSearch);
      document.getElementById('commune-filter-select').addEventListener('change', handleCommuneFilter);
      document.getElementById('bulk-assign-btn').addEventListener('click', handleBulkAssign);

      // botones principales
      document.getElementById('process-btn').addEventListener('click', handleProcessRoute);
      generateListBtn.addEventListener('click', handleGenerateRouteXLList);
      generatePreviewBtn.addEventListener('click', handleGeneratePreview);
      document.getElementById('cleanup-btn').addEventListener('click', handleCleanup);

      // barra de acciones del preview
      document.getElementById('move-selected-btn').addEventListener('click', handleMoveSelectedOrders);
      document.getElementById('expand-all-btn').addEventListener('click', () => toggleAllPanels(true));
      document.getElementById('collapse-all-btn').addEventListener('click', () => toggleAllPanels(false));

      // Delegaci√≥n: acorde√≥n (toggle + seleccionar todo en panel)
      previewPanel.addEventListener('click', (e) => {
        // toggle de panel
        const header = e.target.closest('.van-accordion-header');
        if (header && !e.target.closest('.van-accordion-actions')) {
          const content = header.nextElementSibling;
          content.style.display = content.style.display === 'block' ? 'none' : 'block';
          return;
        }

        // seleccionar todo en un panel
        if (e.target && e.target.classList.contains('select-all-in-panel')) {
          const panel = e.target.closest('.van-accordion');
          if (!panel) return;
          panel.querySelectorAll('.move-order-checkbox').forEach(cb => cb.checked = true);
        }

        // bot√≥n "Seleccionar por comuna" en SIN ASIGNAR
        if (e.target && e.target.id === 'select-by-commune-btn') {
          handleSelectUnassignedByCommune();
        }
      });

      // Acorde√≥n RouteXL (ya existente)
      document.getElementById('routexl-output-container').addEventListener('click', function(e) {
        const header = e.target.closest('.routexl-accordion-header');
        if (e.target.classList.contains('copy-van-list-btn')) {
          const txt = e.target.dataset.copyText;
          if (txt) navigator.clipboard.writeText(txt).then(()=>alert('¬°Lista copiada al portapapeles!')).catch(()=>alert('Error al copiar la lista.'));
          return;
        }
        if (header) {
          const content = header.nextElementSibling;
          content.style.display = content.style.display === 'block' ? 'none' : 'block';
        }
      });

      // modal error
      document.getElementById('close-error-btn').addEventListener('click', () => { document.getElementById('error-modal').style.display='none'; });
      document.getElementById('copy-error-btn').addEventListener('click', () => {
        const msg = document.getElementById('error-message-content').textContent;
        navigator.clipboard.writeText(msg).then(()=>{
          const b = document.getElementById('copy-error-btn'); b.textContent='¬°Copiado!'; setTimeout(()=>b.textContent='Copiar Error',2000);
        });
      });
    }

    function toggleAllPanels(expand) {
      document.querySelectorAll('.van-accordion-content').forEach(c => c.style.display = expand ? 'block' : 'none');
    }

    // ========= Aux de preview =========
    function handleMoveSelectedOrders() {
      const targetVan = document.getElementById('move-target-van').value;
      if (targetVan === '--UNASSIGN--') return;
      const checks = document.querySelectorAll('.move-order-checkbox:checked');
      if (checks.length === 0) { alert('Selecciona al menos un pedido.'); return; }

      let moved = 0;
      checks.forEach(cb => {
        const num = cb.dataset.orderNumber;
        const row = ordersTableBody.querySelector(`tr[data-order-number="${num}"]`);
        if (row) {
          const sel = row.querySelector('select[data-field="van"]');
          if (sel.value !== targetVan) { sel.value = targetVan; sel.dispatchEvent(new Event('change',{bubbles:true})); moved++; }
        }
      });
      if (moved > 0) {
        statusLog.textContent = 'Actualizando vista...';
        setTimeout(()=>{ handleGeneratePreview(); statusLog.textContent = `${moved} pedido(s) movido(s).`; }, 800);
      } else {
        alert('No se realizaron cambios.');
      }
    }

    function handleSelectUnassignedByCommune() {
      const c = document.getElementById('unassigned-commune-filter').value;
      if (!c) { alert('Selecciona una comuna.'); return; }
      let found = 0;
      document.querySelectorAll('#unassigned-orders-ul li').forEach(li => {
        if (li.dataset.commune === c) {
          const cb = li.querySelector('.move-order-checkbox'); if (cb) { cb.checked = true; found++; }
        }
      });
      if (found === 0) alert('No hay pedidos de esa comuna en este panel.');
    }

    function handleGeneratePreview() {
      const ordersByVan = { 'SIN ASIGNAR': [] };

      ordersTableBody.querySelectorAll('tr').forEach(row => {
        const van = row.querySelector('[data-field="van"]').value;
        const order = {
          number: row.dataset.orderNumber,
          customer: row.cells[1].textContent.trim(),
          address: row.querySelector('[data-field="address"]').value,
          commune: row.querySelector('[data-field="commune"]').value
        };
        if (van) { (ordersByVan[van] ||= []).push(order); }
        else { ordersByVan['SIN ASIGNAR'].push(order); }
      });

      // barra acciones
      const moveTargetVanSelect = document.getElementById('move-target-van');
      moveTargetVanSelect.innerHTML = '<option value="">Mover a Furg√≥n...</option>';
      VANS.forEach(v => { const o=document.createElement('option'); o.value=v; o.textContent=v; moveTargetVanSelect.appendChild(o); });
      moveTargetVanSelect.innerHTML += '<option value="--UNASSIGN--">---</option><option value="">Quitar Asignaci√≥n</option>';
      document.getElementById('preview-action-bar').style.display = 'flex';

      // construir acordeones
      previewAccordions.innerHTML = '';

      // --- SIN ASIGNAR (acorde√≥n rojo) ---
      const ua = ordersByVan['SIN ASIGNAR'];
      previewAccordions.appendChild(buildUnassignedAccordion(ua));

      // --- Ma√±ana/Tarde: un acorde√≥n por furg√≥n con lista compacta
      const morningVans = VANS.filter(v=>v.includes('Ma√±ana')).sort();
      const afternoonVans = VANS.filter(v=>v.includes('Tarde')).sort();

      if (morningVans.some(v => ordersByVan[v]?.length)) {
        previewAccordions.appendChild(sectionTitle('Ma√±ana'));
        morningVans.forEach(v => { if (ordersByVan[v]?.length) previewAccordions.appendChild(buildVanAccordion(v, ordersByVan[v])); });
      }
      if (afternoonVans.some(v => ordersByVan[v]?.length)) {
        previewAccordions.appendChild(sectionTitle('Tarde'));
        afternoonVans.forEach(v => { if (ordersByVan[v]?.length) previewAccordions.appendChild(buildVanAccordion(v, ordersByVan[v])); });
      }
    }

    function sectionTitle(text) {
      const el = document.createElement('h4'); el.textContent = text; el.style.margin='16px 0 8px';
      return el;
    }

    function buildUnassignedAccordion(list) {
      const wrap = document.createElement('div'); wrap.className = 'unassigned';
      const acc = document.createElement('div'); acc.className = 'van-accordion';
      const header = document.createElement('div'); header.className = 'van-accordion-header';
      header.innerHTML = `<h5>Pedidos Sin Asignar</h5><span class="badge">${list.length}</span>`;
      const actions = document.createElement('div'); actions.className = 'van-accordion-actions';
      actions.innerHTML = `
        <input type="text" id="unassigned-search" placeholder="Buscar en no asignados..." style="width:180px; padding:6px; border:1px solid #ccc; border-radius:4px;">
        <select id="unassigned-commune-filter" style="width:150px; padding:6px;">
          <option value="">Por Comuna...</option>
        </select>
        <button id="select-by-commune-btn" class="action-button sm" style="background:#337ab7;">Seleccionar</button>
        <button class="action-button sm select-all-in-panel" style="background:#6c757d;">Seleccionar todo</button>`;
      header.appendChild(actions);

      const content = document.createElement('div'); content.className = 'van-accordion-content'; content.style.display='block'; // abierto por defecto
      const inner = document.createElement('div'); inner.className = 'van-accordion-content-inner';
      const ul = document.createElement('ul'); ul.id = 'unassigned-orders-ul'; ul.className = 'preview-list';

      if (list.length) {
        list.forEach(o => {
          const full = `#${o.number} - ${o.customer}, ${o.address}, ${o.commune}`;
          const li = document.createElement('li'); li.className='preview-item'; li.dataset.commune = o.commune; li.dataset.searchText = full.toLowerCase();
          li.innerHTML = `<input type="checkbox" class="move-order-checkbox" data-order-number="${o.number}">
                          <span class="order-text" title="${full}"><b>#${o.number}</b> - ${o.customer}, ${o.address}, ${o.commune}</span>`;
          ul.appendChild(li);
        });
      } else {
        const li = document.createElement('li'); li.className='preview-item';
        li.innerHTML = `<span class="order-text"><small><i>Todos los pedidos han sido asignados.</i></small></span>`;
        ul.appendChild(li);
      }
      inner.appendChild(ul); content.appendChild(inner); acc.appendChild(header); acc.appendChild(content); wrap.appendChild(acc);

      // poblar comunas y busqueda
      const communes = [...new Set(list.map(o=>o.commune))].sort();
      const sel = header.querySelector('#unassigned-commune-filter');
      communes.forEach(c => { const opt = document.createElement('option'); opt.value=c; opt.textContent=c; sel.appendChild(opt); });
      header.querySelector('#unassigned-search').addEventListener('input', (e) => {
        const term = e.target.value.toLowerCase();
        ul.querySelectorAll('li.preview-item').forEach(li => li.style.display = (li.dataset.searchText||'').includes(term) ? 'grid' : 'none');
      });

      return wrap;
    }

    function buildVanAccordion(vanName, list) {
      const acc = document.createElement('div'); acc.className = 'van-accordion'; acc.dataset.van = vanName;
      const header = document.createElement('div'); header.className = 'van-accordion-header';
      header.innerHTML = `<h5>${vanName}</h5><span class="badge">${list.length}</span>`;
      const actions = document.createElement('div'); actions.className = 'van-accordion-actions';
      actions.innerHTML = `<button class="action-button sm select-all-in-panel" style="background:#6c757d;">Seleccionar todo</button>`;
      header.appendChild(actions);

      const content = document.createElement('div'); content.className = 'van-accordion-content'; // colapsado inicialmente
      const inner = document.createElement('div'); inner.className = 'van-accordion-content-inner';
      const ul = document.createElement('ul'); ul.className = 'preview-list';

      list.forEach(o => {
        const full = `#${o.number} - ${o.customer}, ${o.address}, ${o.commune}`;
        const li = document.createElement('li'); li.className='preview-item';
        li.innerHTML = `<input type="checkbox" class="move-order-checkbox" data-order-number="${o.number}">
                        <span class="order-text" title="${full}"><b>#${o.number}</b> - ${o.customer}, ${o.address}, ${o.commune}</span>`;
        ul.appendChild(li);
      });

      inner.appendChild(ul); content.appendChild(inner); acc.appendChild(header); acc.appendChild(content);
      return acc;
    }

    // ========= Tabla principal y helpers =========
    function setLoadingState(isLoading, message='') {
      statusLog.textContent = message;
      document.querySelectorAll('.action-button').forEach(btn => { if(btn.id!=='copy-list-btn') btn.disabled = isLoading; });
    }

    function loadInitialData() {
      setLoadingState(true, 'Cargando datos iniciales...');
      google.script.run.withSuccessHandler(populateOrdersTable).withFailureHandler(handleError).getOrdersForRouting();
    }

    function populateOrdersTable(orders) {
      populateDatalists(orders);
      populateTable(orders);
      setLoadingState(false, `Se cargaron ${orders.length} pedidos √∫nicos.`);
    }

    function populateDatalists(orders) {
      const a=new Set(), d=new Set(), c=new Set();
      orders.forEach(o=>{ if(o.address)a.add(o.address); if(o.department)d.add(o.department); if(o.commune)c.add(o.commune); });
      const esc=s=>String(s||'').replace(/"/g,'&quot;');
      document.getElementById('address-list').innerHTML=[...a].map(v=>`<option value="${esc(v)}"></option>`).join('');
      document.getElementById('department-list').innerHTML=[...d].map(v=>`<option value="${esc(v)}"></option>`).join('');
      document.getElementById('commune-list').innerHTML=[...c].map(v=>`<option value="${esc(v)}"></option>`).join('');
      const sel=document.getElementById('commune-filter-select');
      sel.innerHTML='<option value="">Filtrar por Comuna</option>';
      [...c].sort().forEach(cm=>{ const o=document.createElement('option'); o.value=cm; o.textContent=cm; sel.appendChild(o); });
    }

    function populateTable(orders) {
      ordersTableBody.innerHTML = '';
      orders.forEach(o => {
        const row = ordersTableBody.insertRow();
        row.dataset.orderNumber = o.orderNumber;
        row.innerHTML = `
          <td>${o.orderNumber}</td>
          <td>${o.customerName}</td>
          <td>${o.phone || ''}</td>
          <td><input type="text" class="data-input" data-field="address" value="${o.address || ''}" list="address-list"></td>
          <td><input type="text" class="data-input" data-field="department" value="${o.department || ''}" list="department-list"></td>
          <td><input type="text" class="data-input" data-field="commune" value="${o.commune || ''}" list="commune-list"></td>
          <td>${o.status || ''}</td>
          <td>
            <select class="data-input" data-field="van">
              <option value="">-- Sin Asignar --</option>
              ${VANS.map(v => `<option value="${v}" ${o.van===v?'selected':''}>${v}</option>`).join('')}
            </select>
          </td>`;
      });
    }

    function handleAutoSaveChanges(el) {
      const row = el.closest('tr'); if(!row) return;
      const data = {
        orderNumber: row.dataset.orderNumber,
        phone: row.cells[2].textContent.trim(),
        address: row.querySelector('[data-field="address"]').value,
        department: row.querySelector('[data-field="department"]').value,
        commune: row.querySelector('[data-field="commune"]').value,
        van: row.querySelector('[data-field="van"]').value
      };
      statusLog.textContent = `Guardando cambios para el pedido #${data.orderNumber}...`;
      google.script.run.withSuccessHandler(resp=>{
        statusLog.textContent = resp.message;
        setTimeout(()=>{ if(statusLog.textContent===resp.message) statusLog.textContent='Listo.'; },3000);
      }).withFailureHandler(handleError).saveSingleOrderChange(data);
    }

    function handleOrderSearch(e) {
      const term = e.target.value.toLowerCase();
      ordersTableBody.querySelectorAll('tr').forEach(row => {
        let t=''; row.querySelectorAll('td').forEach(c=>{
          const i=c.querySelector('input, select'); t += (i? i.value : c.textContent) + ' ';
        });
        row.style.display = t.toLowerCase().includes(term) ? '' : 'none';
      });
    }

    function handleCommuneFilter(e) {
      const c = e.target.value;
      ordersTableBody.querySelectorAll('tr').forEach(row => {
        const inp = row.cells[5].querySelector('input');
        if (inp) row.style.display = (c === "" || inp.value === c) ? '' : 'none';
      });
    }

    function handleBulkAssign() {
      const cm = document.getElementById('commune-filter-select').value;
      const v = document.getElementById('bulk-van-select').value;
      if (!cm) { alert('Primero filtra por una comuna.'); return; }
      if (!v) { alert('Selecciona un furg√≥n.'); return; }
      const updated=[], rows=ordersTableBody.querySelectorAll('tr'); let n=0;
      rows.forEach(r=>{
        if (r.style.display==='none') return;
        const ci=r.querySelector('[data-field="commune"]');
        if (ci && ci.value===cm) {
          const vs=r.querySelector('[data-field="van"]');
          if (vs) { vs.value=v; n++; updated.push({
            orderNumber:r.dataset.orderNumber, phone:r.cells[2].textContent.trim(),
            address:r.querySelector('[data-field="address"]').value,
            department:r.querySelector('[data-field="department"]').value,
            commune:ci.value, van:vs.value
          });}
        }
      });
      if (n>0) {
        statusLog.textContent=`Asignando furg√≥n a ${n} pedidos...`;
        google.script.run.withSuccessHandler(()=>{
          alert(`${n} pedidos de "${cm}" asignados a "${v}". Cambios guardados.`);
          statusLog.textContent='Asignaci√≥n masiva completada.';
        }).withFailureHandler(handleError).saveRouteChanges(updated);
      } else { alert('No hay pedidos visibles para esa comuna.'); }
    }

    // ========= RouteXL =========
    function handleGenerateRouteXLList() {
      const byVan = {};
      ordersTableBody.querySelectorAll('tr').forEach(r => {
        const van = r.querySelector('[data-field="van"]').value;
        if (!van) return;
        (byVan[van] ||= []);
        const orderNumber = '#' + r.dataset.orderNumber;
        const address = r.querySelector('[data-field="address"]').value.trim();
        const commune = r.querySelector('[data-field="commune"]').value.trim();
        if (address && commune) byVan[van].push({ orderNumber, addressString: `${address}, ${commune}, Chile` });
      });

      const container = document.getElementById('routexl-output-container');
      container.innerHTML = '';
      const vans = Object.keys(byVan).sort();
      if (vans.length===0) { container.innerHTML = '<p style="font-style: italic;">No hay pedidos con furg√≥n asignado para generar listas.</p>'; return; }
      vans.forEach(van => {
        const orders = byVan[van];
        const item = document.createElement('div'); item.className='routexl-accordion-item';
        const header = document.createElement('div'); header.className='routexl-accordion-header';
        const title = document.createElement('span'); title.textContent = `${van} (${orders.length} direcciones)`;
        const btn = document.createElement('button'); btn.className='action-button sm copy-van-list-btn'; btn.textContent='Copiar Tabla'; btn.style.background='#6c757d';
        btn.dataset.copyText = orders.map(o => `${o.orderNumber}\t${o.addressString}`).join('\n');
        header.appendChild(title); header.appendChild(btn);

        const content = document.createElement('div'); content.className='routexl-accordion-content';
        content.style.maxHeight='200px'; content.style.overflowY='auto';
        let html = '<table style="font-size: 12px;"><thead><tr><th style="font-weight:bold;">Nombre (N¬∫ Pedido)</th><th style="font-weight:bold;">Direcci√≥n</th></tr></thead><tbody>';
        orders.forEach(o=>{ html += `<tr><td>${o.orderNumber}</td><td>${o.addressString}</td></tr>`; });
        html += '</tbody></table>'; content.innerHTML = html;

        item.appendChild(header); item.appendChild(content); container.appendChild(item);
      });
    }

    // ========= Paso 2 / Limpieza =========
    function handleProcessRoute() {
      const vanName = document.getElementById('process-van-select').value;
      const text = routeXlInput.value;
      if (!vanName) { alert("Selecciona el furg√≥n."); return; }
      if (!text.trim()) { alert("El campo de RouteXL est√° vac√≠o."); return; }
      setLoadingState(true, `Procesando ruta para ${vanName}...`);
      google.script.run.withSuccessHandler(handleSuccess).withFailureHandler(handleError).processRouteXLData(text, vanName);
    }

    function handleCleanup() {
      if (!confirm("¬øEliminar TODAS las hojas de 'Envasado' y 'Ruta' generadas previamente?")) return;
      setLoadingState(true, 'Eliminando hojas antiguas...');
      google.script.run.withSuccessHandler(r=>{ handleSuccess(r.message); }).withFailureHandler(handleError).cleanupRouteSheets();
    }

    function handleSuccess(r) {
      setLoadingState(false);
      if (r && r.status==='success' && r.packagingPdfUrl) showPdfLinks(r);
      else if (r && r.message) alert(r.message);
      else if (typeof r === 'string') alert(r);
      else alert('Operaci√≥n completada.');
    }
    function showPdfLinks(r) {
      document.getElementById('results-message').textContent = r.message;
      document.getElementById('pdf-links-container').innerHTML = `
        <a href="${r.packagingPdfUrl}" target="_blank" class="action-button" style="background:#5cb85c; margin-bottom:10px; display:inline-block; width:80%; max-width:400px;">Imprimir/Descargar PDF de Envasado (Vertical)</a><br>
        <a href="${r.routePdfUrl}" target="_blank" class="action-button" style="background:#337ab7; display:inline-block; width:80%; max-width:400px;">Imprimir/Descargar PDF de Ruta (Horizontal)</a>`;
      document.getElementById('results-card').style.display = 'block';
      statusLog.textContent = 'Proceso completado. Los enlaces para imprimir est√°n listos.';
    }
    function handleError(error) {
      setLoadingState(false, `Error: ${error.message}`);
      document.getElementById('error-message-content').textContent = error.message;
      document.getElementById('error-modal').style.display = 'block';
    }
  </script>

  <!-- Modal de Error -->
  <div id="error-modal" class="error-modal">
    <div class="error-modal-content">
      <h3>Ocurri√≥ un Error</h3>
      <pre id="error-message-content"></pre>
      <div class="error-modal-footer">
        <button id="copy-error-btn" class="action-button" style="background:#5bc0de;">Copiar Error</button>
        <button id="close-error-btn" class="action-button" style="background:#6c757d;">Cerrar</button>
      </div>
    </div>
  </div>
</body>
</html>
