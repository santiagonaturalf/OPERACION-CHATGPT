<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      background-color: #f8f9fa;
      margin: 0;
      padding: 20px;
    }
    h1 {
      color: #202124;
      font-size: 24px;
      margin-bottom: 16px;
    }
    #controls {
      margin-bottom: 20px;
      display: flex;
      align-items: center;
    }
    #approveBtn, #cancelBtn {
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
      font-weight: 500;
      margin-right: 10px;
    }
    #approveBtn {
      background-color: #1a73e8;
      color: white;
    }
    #approveBtn:disabled {
      background-color: #e0e0e0;
      cursor: not-allowed;
    }
    #cancelBtn {
      background-color: #f1f3f4;
      color: #202124;
    }
    #status {
      margin-left: auto;
      font-style: italic;
      color: #5f6368;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background-color: white;
      box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
    }
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #dee2e6;
    }
    th {
      background-color: #f1f3f4;
      font-weight: 500;
      color: #3c4043;
    }
    tr.status-anomaly { background-color: #fce8e6; }
    tr.status-new { background-color: #e8f0fe; }
    .currency { text-align: right; }
    .percent { text-align: right; }
    .status-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }
    .status-ok { background-color: #e6f4ea; color: #1e8e3e; }
    .status-anomaly { background-color: #fce8e6; color: #d93025; }
    .status-new { background-color: #e8f0fe; color: #1967d2; }
  </style>
</head>
<body>
  <h1>Revisar y Aprobar Precios de Adquisici√≥n</h1>

  <div id="controls">
    <button id="approveBtn">Aprobar y Guardar Precios</button>
    <button id="cancelBtn">Cancelar</button>
    <span id="status"></span>
  </div>

  <table>
    <thead>
      <tr>
        <th>Producto</th>
        <th class="currency">Costo Hoy</th>
        <th class="currency">Precio Venta</th>
        <th class="percent">Margen</th>
        <th class="currency">Costo Promedio</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody>
      <? const formatCurrency = (num) => num.toLocaleString('es-CL', { style: 'currency', currency: 'CLP', minimumFractionDigits: 0 }); ?>
      <? const analysisData = analysisResults; ?>
      <? if (analysisData && analysisData.length > 0) { ?>
        <? for (let item of analysisData) { ?>
          <? let margin = 0; ?>
          <? if (item.precioVenta > 0) { margin = ((item.precioVenta - item.costoHoy) / item.precioVenta) * 100; } ?>
          <tr class="status-<?= item.status ?>">
            <td>
              <strong><?= item.nombreProducto ?></strong><br>
              <small style="color: #5f6368;"><?= item.proveedor ?> - <?= item.formatoCompra ?></small>
            </td>
            <td class="currency"><?= formatCurrency(item.costoHoy) ?></td>
            <td class="currency"><?= formatCurrency(item.precioVenta) ?></td>
            <td class="percent"><?= margin.toFixed(1) ?>%</td>
            <td class="currency"><?= formatCurrency(item.costoPromedio) ?></td>
            <td><span class="status-badge status-<?= item.status ?>"><?= item.status ?></span></td>
          </tr>
        <? } ?>
      <? } else { ?>
        <tr>
          <td colspan="6" style="text-align:center; padding: 20px;">No se encontraron adquisiciones para analizar hoy.</td>
        </tr>
      <? } ?>
    </tbody>
  </table>

  <script>
    const analysisData = <?= JSON.stringify(analysisResults) ?>;

    document.getElementById('cancelBtn').addEventListener('click', () => {
      google.script.host.close();
    });

    document.getElementById('approveBtn').addEventListener('click', () => {
      const btn = document.getElementById('approveBtn');
      const statusSpan = document.getElementById('status');

      btn.disabled = true;
      statusSpan.textContent = 'Guardando...';

      google.script.run
        .withSuccessHandler(response => {
          google.script.host.close();
          // Optionally, show a toast or alert in the main sheet, but closing is often enough.
        })
        .withFailureHandler(error => {
          statusSpan.textContent = `Error: ${error.message}`;
          alert(`Error al guardar: ${error.message}`);
          btn.disabled = false;
        })
        .commitPriceData(analysisData);
    });
  </script>
</body>
</html>
