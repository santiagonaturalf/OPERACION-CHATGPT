<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8" />
  <title>Dashboard Operaciones SNF</title>
  <script src="https://www.gstatic.com/charts/loader.js"></script>
  <style>
    :root{ --gap:12px; }
    body{ font-family: Inter, Roboto, Arial, sans-serif; margin:0; padding: 16px; background-color: #f0f2f5; }
    .main-container { max-width: 1200px; margin: auto; }
    .row{ display:grid; grid-template-columns: 1fr 1fr; gap: var(--gap); align-items:stretch; }
    .card{ border:1px solid #e5e7eb; border-radius:14px; padding:14px; box-shadow:0 1px 4px rgba(0,0,0,.06); background:#fff; }
    .card h2, .card h3{ margin:0 0 10px 0; font-size:16px; }
    .controls{ display:flex; gap:8px; flex-wrap: wrap; align-items:flex-end; }
    .controls label{ display:block; font-size:12px; color:#555; margin-bottom:4px; }
    .controls input{ height:36px; border:1px solid #d1d5db; border-radius:10px; padding:0 10px; min-width:220px; box-sizing: border-box; }
    .controls button{ height:36px; border:0; border-radius:10px; padding:0 14px; cursor:pointer; background:#111827; color:#fff; }

    .results{ margin-top:16px; }
    .result-row{ border:1px solid #e8e8e8; border-radius:12px; margin-bottom:10px; overflow:hidden; }
    .result-head{ display:grid; grid-template-columns: 2fr 1fr 40px; gap:8px; align-items:center; padding:10px 12px; background:#f9fafb; cursor:pointer; }
    .pill{ display:inline-block; padding:2px 8px; border-radius:999px; background:#eef2ff; font-size:12px; }
    .result-body{ display:none; padding:12px; background:#fff; border-top:1px solid #eee; }
    .result-body dl{ display:grid; grid-template-columns: 220px 1fr; gap:8px 12px; margin:0; }
    .toggle{ text-align:center; font-weight:bold; }
    .muted{ color:#6b7280; font-size:12px; }
    .small{ font-size:12px; }
    .empty{ padding:16px; color:#6b7280; text-align: center; }

    h1 { color: #1c1e21; margin-bottom: 16px; }
    #actions-card { margin-top: 16px; }
    .actions-grid { display: grid; grid-template-columns: 1fr 1fr; grid-gap: 15px; }
     .action-button {
      display: block; width: 100%; padding: 12px; margin-bottom: 10px; font-size: 14px;
      font-weight: bold; border-radius: 5px; border: none; cursor: pointer; text-align: left;
      transition: background-color 0.2s;
    }
    #paste-import-btn { background-color: #0d6efd; color: white; }
    #clean-btn { background-color: #dc3545; color: white; }
    #import-movements-btn { background-color: #ffc107; color: black; }
    #conciliation-btn { background-color: #ffc107; color: black; }
    #packaging-btn, #acq-btn, #notify-btn, #comanda-rutas-btn { background-color: #6c757d; color: white; }
    #status-log { font-size: 12px; font-style: italic; color: #606770; margin-top: 15px; min-height: 18px;}


    @media (max-width: 900px){
      .row{ grid-template-columns: 1fr; }
      .result-head{ grid-template-columns: 1fr 100px 40px; }
      .result-body dl{ grid-template-columns: 1fr; }
      .actions-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
<div class="main-container">
  <h1>Dashboard de Operaciones</h1>

  <div class="row">
    <!-- IZQUIERDA: Gr√°fico de Comunas -->
    <div class="card">
      <h3>Distribuci√≥n de Pedidos por Comuna</h3>
      <div id="chart-comunas" style="width:100%; height:300px;"></div>
      <div id="chart-note" class="muted small">Fuente: <em>Orders</em></div>
    </div>

    <!-- DERECHA: Buscador -->
    <div class="card">
      <h3>Buscador (Producto / N¬∫ Pedido)</h3>
      <div class="controls">
        <div>
          <label>Nombre Producto (contiene)</label>
          <input id="inp-producto" placeholder="Ej: Naranja, Chirimoya" />
        </div>
        <div>
          <label>N¬∫ de Pedido (exacto)</label>
          <input id="inp-pedido" placeholder="Ej: 12345" />
        </div>
        <div>
          <button id="btn-buscar">Buscar</button>
        </div>
      </div>

      <div class="results" id="results"></div>
    </div>
  </div>

  <div id="actions-card" class="card">
    <h2>Flujo de Trabajo Diario</h2>
    <div class="actions-grid">
        <div>
            <p><strong>Paso 1:</strong> Carga los pedidos del d√≠a.</p>
            <button id="paste-import-btn" class="action-button">Importar Pedidos (Copiar y Pegar)</button>
            <p><strong>Paso 2:</strong> Revisa y limpia los datos.</p>
            <button id="clean-btn" class="action-button">Limpiar Datos (Duplicados y Proveedores)</button>
            <p><strong>Paso 3:</strong> Importa los movimientos del banco.</p>
            <button id="import-movements-btn" class="action-button">Importar Movimientos Bancarios</button>
            <p><strong>Paso 4:</strong> Concilia los ingresos de ventas.</p>
            <button id="conciliation-btn" class="action-button">Conciliar Ingresos de Ventas</button>
        </div>
        <div>
            <p><strong>Acciones de Operaci√≥n:</strong></p>
            <button id="packaging-btn" class="action-button">‚ñ∂Ô∏è Iniciar Proceso de Envasado</button>
            <button id="acq-btn" class="action-button">üìù Generar Adquisiciones</button>
            <button id="notify-btn" class="action-button">üì≤ Notificar a Proveedores</button>
            <button id="comanda-rutas-btn" class="action-button">üöö Comanda Rutas</button>
        </div>
    </div>
    <div id="status-log">Bienvenido.</div>
  </div>
</div>

  <script>
    // --- L√ìGICA PARA NUEVO DASHBOARD (DEL USUARIO) ---
    google.charts.load('current', {'packages':['corechart']});
    google.charts.setOnLoadCallback(drawComunas);

    function drawComunas(){
      google.script.run.withSuccessHandler(res => {
        if (!res || !res.ok){
          document.getElementById('chart-comunas').innerHTML = '<div class="empty">' + (res && res.error ? res.error : 'No hay datos de comunas') + '</div>';
          return;
        }
        const data = new google.visualization.DataTable();
        data.addColumn('string','Comuna');
        data.addColumn('number','Pedidos');
        res.items.forEach(x => data.addRow([x.comuna, Number(x.cantidadPedidos)||0]));
        const chart = new google.visualization.PieChart(document.getElementById('chart-comunas'));
        chart.draw(data, { pieHole: 0.35, legend: { position: 'right' } });
      }).getDistribucionComunas();
    }

    document.getElementById('btn-buscar').addEventListener('click', doSearch);
    document.getElementById('inp-producto').addEventListener('keydown', e=>{ if(e.key==='Enter') doSearch(); });
    document.getElementById('inp-pedido').addEventListener('keydown', e=>{ if(e.key==='Enter') doSearch(); });

    function doSearch(){
      const productoText = document.getElementById('inp-producto').value.trim();
      const numeroPedido = document.getElementById('inp-pedido').value.trim();
      const cont = document.getElementById('results');
      cont.innerHTML = '<div class="muted small">Buscando...</div>';

      google.script.run.withSuccessHandler(res => {
        if (!res || !res.ok){
          cont.innerHTML = '<div class="empty">' + (res && res.error ? res.error : 'Sin resultados') + '</div>';
          return;
        }
        if (!res.items || !res.items.length){
          cont.innerHTML = '<div class="empty">No se encontraron coincidencias.</div>';
          return;
        }
        cont.innerHTML = '';
        res.items.forEach((row, i) => cont.appendChild(renderResult(row, i)));
        attachToggles();
      }).buscarProductosYPedidos({ productoText, numeroPedido });
    }

    function renderResult(row, idx){
      const wrap = document.createElement('div');
      wrap.className = 'result-row';
      wrap.innerHTML = `
        <div class="result-head" data-idx="${idx}">
          <div><strong>${escapeHtml(row.producto)}</strong></div>
          <div><span class="pill">${fmt(row.cantidadVendida)}</span></div>
          <div class="toggle">+</div>
        </div>
        <div class="result-body" id="rb-${idx}">
          <dl>
            <dt>N√∫meros de Pedidos</dt><dd>${(row.pedidos && row.pedidos.length) ? row.pedidos.map(escapeHtml).join(', ') : '<span class="muted">‚Äî</span>'}</dd>
            <dt>Inventario Actual</dt><dd>${row.inventarioActual ? escapeHtml(row.inventarioActual) : '<span class="muted">‚Äî</span>'}</dd>
            <dt>Adquisiciones Hoy</dt><dd>${(row.adquisicionesHoy && (row.adquisicionesHoy.cantidad || row.adquisicionesHoy.formato)) ? `${escapeHtml(row.adquisicionesHoy.cantidad)} ${escapeHtml(row.adquisicionesHoy.formato||'')}` : '<span class="muted">‚Äî</span>'}</dd>
            <dt>Inventario al finalizar</dt><dd>${row.inventarioFinal ? escapeHtml(row.inventarioFinal) : '<span class="muted">‚Äî</span>'}</dd>
          </dl>
        </div>`;
      return wrap;
    }

    function attachToggles(){
      document.querySelectorAll('.result-head').forEach(head => {
        head.addEventListener('click', () => {
          const idx = head.getAttribute('data-idx');
          const body = document.getElementById('rb-'+idx);
          const tog  = head.querySelector('.toggle');
          const isOpen = body.style.display === 'block';
          body.style.display = isOpen ? 'none' : 'block';
          tog.textContent = isOpen ? '+' : '‚àí';
        });
      });
    }

    function fmt(n){
      n = Number(n)||0; return new Intl.NumberFormat('es-CL', {maximumFractionDigits:2}).format(n);
    }

    function escapeHtml(s){
      return (s==null?'' : s.toString())
        .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;');
    }

    // --- L√ìGICA PARA BOTONES ORIGINALES ---
    const statusLog = document.getElementById('status-log');
    const allButtons = document.querySelectorAll('.action-button');

    function setLoadingState(isLoading, message = '') {
        statusLog.textContent = message;
        allButtons.forEach(btn => btn.disabled = isLoading);
    }

    function handleSuccess(message) {
        setLoadingState(false, message);
        alert(message);
    }

    function handleError(err) {
       setLoadingState(false, `Error: ${err.message}`);
       alert(`Error: ${err.message}`);
    }

    document.getElementById('paste-import-btn').addEventListener('click', () => google.script.run.showPasteImportDialog());
    document.getElementById('clean-btn').addEventListener('click', () => {
        setLoadingState(true, 'Iniciando limpieza de datos...');
        google.script.run.withSuccessHandler(handleSuccess).withFailureHandler(handleError).startDashboardRefresh();
    });
    document.getElementById('import-movements-btn').addEventListener('click', () => google.script.run.showImportMovementsDialog());
    document.getElementById('conciliation-btn').addEventListener('click', () => google.script.run.showConciliationDialog());
    document.getElementById('packaging-btn').addEventListener('click', () => google.script.run.startPackagingProcess());
    document.getElementById('acq-btn').addEventListener('click', () => {
        setLoadingState(true, 'Generando borrador y abriendo editor...');
        google.script.run.withSuccessHandler(() => setLoadingState(false)).withFailureHandler(handleError).showAcquisitionEditor();
    });
    document.getElementById('notify-btn').addEventListener('click', () => google.script.run.openNotificationPanel());
    document.getElementById('comanda-rutas-btn').addEventListener('click', () => google.script.run.showComandaRutasDialog());
  </script>
</body>
</html>
