<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8" />
  <title>Dashboard Operaciones SNF</title>
  <script src="https://www.gstatic.com/charts/loader.js"></script>
  <style>
    :root{ --gap:12px; }
    body{ font-family: Inter, Roboto, Arial, sans-serif; margin:0; padding: 16px; background-color: #f0f2f5; }
    .main-container { max-width: 1200px; margin: auto; }
    .row{ display:grid; grid-template-columns: 1fr auto 1fr; gap: var(--gap); align-items:stretch; }
    .card{ border:1px solid #e5e7eb; border-radius:14px; padding:14px; box-shadow:0 1px 4px rgba(0,0,0,.06); background:#fff; }
    .card h2, .card h3{ margin:0 0 10px 0; font-size:16px; }
    .summary-card { text-align: center; justify-content: center; display: flex; flex-direction: column; }
    .summary-card h3 { font-size: 28px; margin: 0; color: #0d6efd; }
    .summary-card p { margin: 4px 0 0 0; font-size: 13px; color: #6b7280; }
    .controls{ display:flex; gap:8px; flex-wrap: wrap; align-items:flex-end; }
    .controls label{ display:block; font-size:12px; color:#555; margin-bottom:4px; }
    .controls input{ height:36px; border:1px solid #d1d5db; border-radius:10px; padding:0 10px; min-width:220px; box-sizing: border-box; }
    .controls button{ height:36px; border:0; border-radius:10px; padding:0 14px; cursor:pointer; background:#111827; color:#fff; }

    .results{ margin-top:16px; }
    .result-row{ border:1px solid #e8e8e8; border-radius:12px; margin-bottom:10px; overflow:hidden; }
    .result-head{ display:grid; grid-template-columns: 2fr 1fr 40px; gap:8px; align-items:center; padding:10px 12px; background:#f9fafb; cursor:pointer; }
    .pill{ display:inline-block; padding:2px 8px; border-radius:999px; background:#eef2ff; font-size:12px; }
    .result-body{ display:none; padding:12px; background:#fff; border-top:1px solid #eee; }
    .result-body dl{ display:grid; grid-template-columns: 220px 1fr; gap:8px 12px; margin:0; }
    .toggle{ text-align:center; font-weight:bold; }
    .muted{ color:#6b7280; font-size:12px; }
    .small{ font-size:12px; }
    .empty{ padding:16px; color:#6b7280; text-align: center; }

    h1 { color: #1c1e21; margin-bottom: 16px; }
    #actions-card { margin-top: 16px; }
    .actions-grid { display: grid; grid-template-columns: 1fr 1fr; grid-gap: 15px; }
     .action-button {
      display: block; width: 100%; padding: 12px; margin-bottom: 10px; font-size: 14px;
      font-weight: bold; border-radius: 5px; border: none; cursor: pointer; text-align: left;
      transition: background-color 0.2s;
    }
    #paste-import-btn { background-color: #0d6efd; color: white; }
    #clean-btn { background-color: #dc3545; color: white; }
    #import-movements-btn { background-color: #ffc107; color: black; }
    #conciliation-btn { background-color: #ffc107; color: black; }
    #packaging-btn, #acq-btn, #notify-btn, #comanda-rutas-btn { background-color: #6c757d; color: white; }
    #status-log { font-size: 12px; font-style: italic; color: #606770; margin-top: 15px; min-height: 18px;}


    @media (max-width: 900px){
      .row{ grid-template-columns: 1fr; }
      .result-head{ grid-template-columns: 1fr 100px 40px; }
      .result-body dl{ grid-template-columns: 1fr; }
      .actions-grid { grid-template-columns: 1fr; }
    }

    /* --- ESTILOS PARA EL MODAL DE ELIMINACI√ìN --- */
    .delete-modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      display: none; /* Se muestra con JS */
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .delete-modal-panel {
      background: #fff;
      border-radius: 14px;
      padding: 24px;
      width: 90%;
      max-width: 1000px;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    .delete-modal-panel h2 {
      margin-top: 0;
      margin-bottom: 16px;
      border-bottom: 1px solid #eee;
      padding-bottom: 12px;
    }
    #delete-search-input {
      width: 100%;
      padding: 10px;
      margin-bottom: 16px;
      border-radius: 8px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    #delete-accordion-container {
      overflow-y: auto;
      flex-grow: 1;
      padding-right: 10px; /* Para que la barra de scroll no se pegue */
    }
    .delete-modal-footer {
      margin-top: 20px;
      text-align: right;
      border-top: 1px solid #eee;
      padding-top: 16px;
    }
    .delete-modal-footer button {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        margin-left: 10px;
    }
    #confirm-delete-btn { background-color: #dc3545; color: white; }
    #cancel-delete-btn { background-color: #6c757d; color: white; }

    /* Estilos del Acorde√≥n */
    .del-order-group { border: 1px solid #ddd; border-radius: 8px; margin-bottom: 8px; overflow: hidden; }
    .del-order-header {
      display: grid;
      grid-template-columns: 20px 1fr 2fr 1fr 1fr 1.5fr 24px;
      gap: 10px;
      align-items: center;
      padding: 10px;
      background: #f7f7f7;
      cursor: pointer;
      font-size: 12px;
    }
    .del-order-header:hover { background: #efefef; }
    .del-order-header > div { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .del-order-header strong { font-size: 13px; }
    .del-order-body { display: none; padding: 0 10px 10px 10px; }
    .del-order-item {
      display: grid;
      grid-template-columns: 20px 1fr 80px;
      gap: 10px;
      align-items: center;
      padding: 8px 5px 8px 30px; /* Indentaci√≥n para los productos */
      border-top: 1px solid #eee;
      font-size: 13px;
    }
     .del-order-item:first-child { border-top: none; margin-top: 5px; }

  </style>
</head>
<body>
<div class="main-container">
  <h1>Dashboard de Operaciones</h1>

  <div class="row">
    <!-- IZQUIERDA: Gr√°fico de Comunas -->
    <div class="card">
      <h3>Distribuci√≥n de Pedidos por Comuna</h3>
      <div id="chart-comunas" style="width:100%; height:300px;"></div>
      <div id="chart-note" class="muted small">Fuente: <em>Orders</em></div>
    </div>

    <!-- CENTRO: Resumen de Preparaci√≥n -->
    <div class="card summary-card">
      <div>
        <h3 id="pedidos-hoy">--</h3>
        <p>Pedidos a Preparar</p>
      </div>
      <hr style="width:80%; border:none; border-top:1px solid #eee; margin: 16px auto;">
      <div>
        <h3 id="paquetes-hoy">--</h3>
        <p>Paquetes a Preparar</p>
      </div>
    </div>

    <!-- DERECHA: Buscador -->
    <div class="card">
      <h3>Buscador (Producto / N¬∫ Pedido)</h3>
      <div class="controls">
        <div>
          <label>Nombre Producto (contiene)</label>
          <input id="inp-producto" placeholder="Ej: Naranja, Chirimoya" />
        </div>
        <div>
          <label>N¬∫ de Pedido (exacto)</label>
          <input id="inp-pedido" placeholder="Ej: 12345" />
        </div>
        <div>
          <button id="btn-buscar">Buscar</button>
        </div>
      </div>

      <div class="results" id="results"></div>
    </div>
  </div>

  <div id="actions-card" class="card">
    <h2>Flujo de Trabajo Diario</h2>
    <div class="actions-grid">
        <div>
            <p><strong>Paso 1:</strong> Carga los pedidos del d√≠a.</p>
            <button id="paste-import-btn" class="action-button">Importar Pedidos (Copiar y Pegar)</button>
            <p><strong>Paso 2:</strong> Revisa y limpia los datos.</p>
            <button id="clean-btn" class="action-button">Limpiar Datos (Duplicados y Proveedores)</button>
            <p><strong>Paso 3:</strong> Importa los movimientos del banco.</p>
            <button id="import-movements-btn" class="action-button">Importar Movimientos Bancarios</button>
            <p><strong>Paso 4:</strong> Concilia los ingresos de ventas.</p>
            <button id="conciliation-btn" class="action-button">Conciliar Ingresos de Ventas</button>
        </div>
        <div>
            <p><strong>Acciones de Operaci√≥n:</strong></p>
            <button id="packaging-btn" class="action-button">‚ñ∂Ô∏è Iniciar Proceso de Envasado</button>
            <button id="acq-btn" class="action-button">üìù Generar Adquisiciones</button>
            <button id="notify-btn" class="action-button">üì≤ Notificar a Proveedores</button>
            <button id="comanda-rutas-btn" class="action-button">üöö Comanda Rutas</button>
        </div>
        <div>
            <p><strong>Gesti√≥n de Pedidos:</strong></p>
            <button id="add-order-btn" class="action-button" style="background-color: #17a2b8;">‚ûï Agregar Pedido</button>
            <button id="delete-order-btn" class="action-button" style="background-color: #dc3545;">‚ûñ Eliminar Pedido</button>
            <button id="view-deleted-btn" class="action-button" style="background-color: #0d6efd;">üëÄ Ver Eliminados o Reincorporar</button>
        </div>
    </div>
    <div id="status-log">Bienvenido.</div>
  </div>
</div>

<!-- MODAL PARA ELIMINAR PEDIDOS -->
<div id="delete-modal-overlay" class="delete-modal-overlay">
  <div class="delete-modal-panel">
    <h2>Eliminar Pedidos o Productos</h2>
    <input type="text" id="delete-search-input" placeholder="Buscar por N¬∫ Pedido, Cliente, Comuna...">

    <div id="delete-accordion-container">
      <!-- El contenido del acorde√≥n se generar√° aqu√≠ con JavaScript -->
    </div>

    <div class="delete-modal-footer">
      <button id="cancel-delete-btn">Cancelar</button>
      <button id="confirm-delete-btn">Confirmar Eliminaci√≥n</button>
    </div>
  </div>
</div>

<!-- MODAL PARA REINCORPORAR PEDIDOS -->
<div id="reincorporate-modal-overlay" class="delete-modal-overlay">
  <div class="delete-modal-panel">
    <h2>Reincorporar Pedidos o Productos</h2>
    <input type="text" id="reincorporate-search-input" placeholder="Buscar por N¬∫ Pedido, Cliente, Comuna...">

    <div id="reincorporate-accordion-container">
      <!-- Contenido se generar√° con JS -->
    </div>

    <div class="delete-modal-footer">
      <button id="cancel-reincorporate-btn">Cancelar</button>
      <button id="confirm-reincorporate-btn" style="background-color: #198754;">Confirmar Reincorporaci√≥n</button>
    </div>
  </div>
</div>

  <script>
    // --- L√ìGICA PARA NUEVO DASHBOARD (DEL USUARIO) ---
    google.charts.load('current', {'packages':['corechart']});
    google.charts.setOnLoadCallback(function() {
      drawComunas();
      drawSummary();
    });

    function drawSummary() {
      google.script.run.withSuccessHandler(res => {
        if (res && res.ok) {
          document.getElementById('pedidos-hoy').innerText = res.data.pedidosHoy;
          document.getElementById('paquetes-hoy').innerText = res.data.paquetesHoy;
        } else {
          document.getElementById('pedidos-hoy').innerText = 'Error';
          document.getElementById('paquetes-hoy').innerText = 'Error';
        }
      }).getDashboardSummary();
    }

    function drawComunas(){
      google.script.run.withSuccessHandler(res => {
        if (!res || !res.ok){
          document.getElementById('chart-comunas').innerHTML = '<div class="empty">' + (res && res.error ? res.error : 'No hay datos de comunas') + '</div>';
          return;
        }
        const data = new google.visualization.DataTable();
        data.addColumn('string','Comuna');
        data.addColumn('number','Pedidos');
        res.items.forEach(x => data.addRow([x.comuna, Number(x.cantidadPedidos)||0]));
        const chart = new google.visualization.PieChart(document.getElementById('chart-comunas'));
        chart.draw(data, { pieHole: 0.35, legend: { position: 'right' } });
      }).getDistribucionComunas();
    }

    document.getElementById('btn-buscar').addEventListener('click', doSearch);
    document.getElementById('inp-producto').addEventListener('keydown', e=>{ if(e.key==='Enter') doSearch(); });
    document.getElementById('inp-pedido').addEventListener('keydown', e=>{ if(e.key==='Enter') doSearch(); });

    function doSearch(){
      const productoText = document.getElementById('inp-producto').value.trim();
      const numeroPedido = document.getElementById('inp-pedido').value.trim();
      const cont = document.getElementById('results');
      cont.innerHTML = '<div class="muted small">Buscando...</div>';

      google.script.run.withSuccessHandler(res => {
        if (!res || !res.ok){
          cont.innerHTML = '<div class="empty">' + (res && res.error ? res.error : 'Sin resultados') + '</div>';
          return;
        }
        if (!res.items || !res.items.length){
          cont.innerHTML = '<div class="empty">No se encontraron coincidencias.</div>';
          return;
        }
        cont.innerHTML = '';
        res.items.forEach((row, i) => cont.appendChild(renderResult(row, i)));
        attachToggles();
      }).buscarProductosYPedidos({ productoText, numeroPedido });
    }

    function renderResult(row, idx){
      const wrap = document.createElement('div');
      wrap.className = 'result-row';
      wrap.innerHTML = `
        <div class="result-head" data-idx="${idx}">
          <div><strong>${escapeHtml(row.producto)}</strong></div>
          <div><span class="pill">${fmt(row.cantidadVendida)}</span></div>
          <div class="toggle">+</div>
        </div>
        <div class="result-body" id="rb-${idx}">
          <dl>
            <dt>N√∫meros de Pedidos</dt><dd>${(row.pedidos && row.pedidos.length) ? row.pedidos.map(escapeHtml).join(', ') : '<span class="muted">‚Äî</span>'}</dd>
            <dt>Inventario Actual</dt><dd>${row.inventarioActual ? escapeHtml(row.inventarioActual) : '<span class="muted">‚Äî</span>'}</dd>
            <dt>Adquisiciones Hoy</dt><dd>${(row.adquisicionesHoy && (row.adquisicionesHoy.cantidad || row.adquisicionesHoy.formato)) ? `${escapeHtml(row.adquisicionesHoy.cantidad)} ${escapeHtml(row.adquisicionesHoy.formato||'')}` : '<span class="muted">‚Äî</span>'}</dd>
            <dt>Inventario al finalizar</dt><dd>${row.inventarioFinal ? escapeHtml(row.inventarioFinal) : '<span class="muted">‚Äî</span>'}</dd>
          </dl>
        </div>`;
      return wrap;
    }

    function attachToggles(){
      document.querySelectorAll('.result-head').forEach(head => {
        head.addEventListener('click', () => {
          const idx = head.getAttribute('data-idx');
          const body = document.getElementById('rb-'+idx);
          const tog  = head.querySelector('.toggle');
          const isOpen = body.style.display === 'block';
          body.style.display = isOpen ? 'none' : 'block';
          tog.textContent = isOpen ? '+' : '‚àí';
        });
      });
    }

    function fmt(n){
      n = Number(n)||0; return new Intl.NumberFormat('es-CL', {maximumFractionDigits:2}).format(n);
    }

    function escapeHtml(s){
      return (s==null?'' : s.toString())
        .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;');
    }

    // --- L√ìGICA PARA BOTONES ORIGINALES ---
    const statusLog = document.getElementById('status-log');
    const allButtons = document.querySelectorAll('.action-button');

    function setLoadingState(isLoading, message = '') {
        statusLog.textContent = message;
        allButtons.forEach(btn => btn.disabled = isLoading);
    }

    function handleSuccess(message) {
        setLoadingState(false, message);
        alert(message);
    }

    function handleError(err) {
       setLoadingState(false, `Error: ${err.message}`);
       alert(`Error: ${err.message}`);
    }

    document.getElementById('paste-import-btn').addEventListener('click', () => google.script.run.showPasteImportDialog());
    document.getElementById('clean-btn').addEventListener('click', () => {
        setLoadingState(true, 'Iniciando limpieza de datos...');
        google.script.run.withSuccessHandler(() => setLoadingState(false)).withFailureHandler(handleError).startDashboardRefresh();
    });
    document.getElementById('import-movements-btn').addEventListener('click', () => google.script.run.showImportMovementsDialog());
    document.getElementById('conciliation-btn').addEventListener('click', () => google.script.run.showConciliationDialog());
    document.getElementById('packaging-btn').addEventListener('click', () => google.script.run.startPackagingProcess());
    document.getElementById('acq-btn').addEventListener('click', () => {
        setLoadingState(true, 'Generando borrador y abriendo editor...');
        google.script.run.withSuccessHandler(() => setLoadingState(false)).withFailureHandler(handleError).showAcquisitionEditor();
    });
    document.getElementById('notify-btn').addEventListener('click', () => google.script.run.openNotificationPanel());
    document.getElementById('comanda-rutas-btn').addEventListener('click', () => google.script.run.showComandaRutasDialog());

    // --- L√ìGICA PARA BOTONES DE GESTI√ìN DE PEDIDOS ---
    document.getElementById('add-order-btn').addEventListener('click', () => {
        google.script.run.showAppendOrdersDialog();
    });

    // --- NUEVA L√ìGICA PARA ELIMINAR PEDIDOS (MODAL) ---
    const deleteModalOverlay = document.getElementById('delete-modal-overlay');
    const accordionContainer = document.getElementById('delete-accordion-container');
    const searchInput = document.getElementById('delete-search-input');
    let allOrdersData = {}; // Cache para los datos de los pedidos

    // 1. Abrir el modal
    document.getElementById('delete-order-btn').addEventListener('click', () => {
      setLoadingState(true, 'Cargando pedidos para eliminar...');
      accordionContainer.innerHTML = 'Cargando...';
      deleteModalOverlay.style.display = 'flex';

      google.script.run
        .withSuccessHandler(response => {
          setLoadingState(false);
          if (response.ok) {
            allOrdersData = response.orders;
            populateDeleteAccordion(allOrdersData);
          } else {
            accordionContainer.innerHTML = `<div class="empty">Error: ${escapeHtml(response.error)}</div>`;
          }
        })
        .withFailureHandler(err => {
            setLoadingState(false);
            accordionContainer.innerHTML = `<div class="empty">Error: ${escapeHtml(err.message)}</div>`;
        })
        .getOrdersForDeletion();
    });

    // 2. Poblar el acorde√≥n
    function populateDeleteAccordion(orders) {
      accordionContainer.innerHTML = ''; // Limpiar
      const orderKeys = Object.keys(orders).sort((a,b) => b - a); // Ordenar por n√∫mero de pedido descendente

      if (orderKeys.length === 0) {
        accordionContainer.innerHTML = '<div class="empty">No hay pedidos disponibles para eliminar.</div>';
        return;
      }

      orderKeys.forEach(orderId => {
        const order = orders[orderId];
        const group = document.createElement('div');
        group.className = 'del-order-group';
        group.setAttribute('data-order-id', orderId);

        let headerHTML = `
          <div class="del-order-header">
            <input type="checkbox" class="order-checkbox" title="Seleccionar todo el pedido">
            <div><strong>#${escapeHtml(order.orderNumber)}</strong></div>
            <div>${escapeHtml(order.customerName)}</div>
            <div><span class="muted">${escapeHtml(order.status)}</span></div>
            <div>${escapeHtml(order.commune)}</div>
            <div><span class="muted">${escapeHtml(order.van)}</span></div>
            <div class="toggle">+</div>
          </div>`;

        let bodyHTML = '<div class="del-order-body">';
        order.items.forEach(item => {
          bodyHTML += `
            <div class="del-order-item">
              <input type="checkbox" class="item-checkbox" data-row-number="${item.rowNumber}">
              <div>${escapeHtml(item.productName)}</div>
              <div>Qty: <strong>${escapeHtml(item.quantity)}</strong></div>
            </div>`;
        });
        bodyHTML += '</div>';

        group.innerHTML = headerHTML + bodyHTML;
        accordionContainer.appendChild(group);
      });

      attachDeleteListeners();
    }

    // 3. A√±adir todos los event listeners
    function attachDeleteListeners() {
      // Toggle del acorde√≥n
      document.querySelectorAll('.del-order-header').forEach(header => {
        header.addEventListener('click', (e) => {
          if (e.target.type === 'checkbox') return; // No toggles si se hace clic en el checkbox
          const body = header.nextElementSibling;
          const toggle = header.querySelector('.toggle');
          const isOpen = body.style.display === 'block';
          body.style.display = isOpen ? 'none' : 'block';
          toggle.textContent = isOpen ? '+' : '‚àí';
        });
      });

      // Checkbox principal del pedido
      document.querySelectorAll('.order-checkbox').forEach(orderChk => {
        orderChk.addEventListener('change', (e) => {
          const body = e.target.closest('.del-order-header').nextElementSibling;
          body.querySelectorAll('.item-checkbox').forEach(itemChk => {
            itemChk.checked = e.target.checked;
          });
        });
      });

      // Checkboxes de items individuales
      document.querySelectorAll('.item-checkbox').forEach(itemChk => {
        itemChk.addEventListener('change', (e) => {
          const body = e.target.closest('.del-order-body');
          const allItemCheckboxes = body.querySelectorAll('.item-checkbox');
          const allChecked = Array.from(allItemCheckboxes).every(chk => chk.checked);
          const orderCheckbox = body.previousElementSibling.querySelector('.order-checkbox');
          orderCheckbox.checked = allChecked;
        });
      });
    }

    // 4. L√≥gica de b√∫squeda/filtrado
    searchInput.addEventListener('keyup', () => {
        const searchTerm = searchInput.value.toLowerCase().trim();
        document.querySelectorAll('.del-order-group').forEach(group => {
            const orderId = group.dataset.orderId;
            const orderData = allOrdersData[orderId];
            const searchableText = [
                orderData.orderNumber,
                orderData.customerName,
                orderData.commune,
                orderData.status,
                orderData.van
            ].join(' ').toLowerCase();

            if (searchableText.includes(searchTerm)) {
                group.style.display = '';
            } else {
                group.style.display = 'none';
            }
        });
    });

    // 5. Botones de Confirmar y Cancelar
    document.getElementById('cancel-delete-btn').addEventListener('click', () => {
      deleteModalOverlay.style.display = 'none';
    });

    document.getElementById('confirm-delete-btn').addEventListener('click', () => {
      const selectedRows = [];
      document.querySelectorAll('.item-checkbox:checked').forEach(chk => {
        selectedRows.push(chk.dataset.rowNumber);
      });

      if (selectedRows.length === 0) {
        alert('Por favor, selecciona al menos un producto para eliminar.');
        return;
      }

      setLoadingState(true, `Eliminando ${selectedRows.length} fila(s)...`);

      google.script.run
        .withSuccessHandler(response => {
           if (response.status === 'success') {
                handleSuccess(response.message);
                deleteModalOverlay.style.display = 'none';
           } else {
                handleError({ message: response.message });
           }
        })
        .withFailureHandler(handleError)
        .deleteSelectedRows(selectedRows);
    });


    // --- L√ìGICA PARA REINCORPORAR PEDIDOS (MODAL) ---
    const reincorporateModalOverlay = document.getElementById('reincorporate-modal-overlay');
    const reincorporateAccordion = document.getElementById('reincorporate-accordion-container');
    const reincorporateSearch = document.getElementById('reincorporate-search-input');
    let allDeletedOrdersData = {};

    // 1. Abrir el modal de reincorporaci√≥n
    document.getElementById('view-deleted-btn').addEventListener('click', () => {
      setLoadingState(true, 'Cargando pedidos eliminados...');
      reincorporateAccordion.innerHTML = 'Cargando...';
      reincorporateModalOverlay.style.display = 'flex';

      google.script.run
        .withSuccessHandler(response => {
          setLoadingState(false);
          if (response.ok) {
            allDeletedOrdersData = response.orders;
            populateReincorporateAccordion(allDeletedOrdersData);
          } else {
            reincorporateAccordion.innerHTML = `<div class="empty">Error: ${escapeHtml(response.error)}</div>`;
          }
        })
        .withFailureHandler(err => {
            setLoadingState(false);
            reincorporateAccordion.innerHTML = `<div class="empty">Error: ${escapeHtml(err.message)}</div>`;
        })
        .getDeletedOrders();
    });

    // 2. Poblar el acorde√≥n de reincorporaci√≥n
    function populateReincorporateAccordion(orders) {
        reincorporateAccordion.innerHTML = '';
        const orderKeys = Object.keys(orders).sort((a, b) => b - a);

        if (orderKeys.length === 0) {
            reincorporateAccordion.innerHTML = '<div class="empty">No se encontraron pedidos eliminados para reincorporar.</div>';
            return;
        }

        orderKeys.forEach(orderId => {
            const order = orders[orderId];
            const group = document.createElement('div');
            group.className = 'del-order-group'; // Reutilizamos la clase
            group.setAttribute('data-order-id', orderId);

            let headerHTML = `
              <div class="del-order-header">
                <input type="checkbox" class="order-checkbox" title="Seleccionar todo el pedido">
                <div><strong>#${escapeHtml(order.orderNumber)}</strong></div>
                <div>${escapeHtml(order.customerName)}</div>
                <div><span class="muted">${escapeHtml(order.status)}</span></div>
                <div>${escapeHtml(order.commune)}</div>
                <div><span class="muted">${escapeHtml(order.van)}</span></div>
                <div class="toggle">+</div>
              </div>`;

            let bodyHTML = '<div class="del-order-body">';
            order.items.forEach(item => {
                bodyHTML += `
                  <div class="del-order-item">
                    <input type="checkbox" class="item-checkbox" data-row-number="${item.rowNumber}">
                    <div>${escapeHtml(item.productName)}</div>
                    <div>Qty: <strong>${escapeHtml(item.quantity)}</strong></div>
                  </div>`;
            });
            bodyHTML += '</div>';

            group.innerHTML = headerHTML + bodyHTML;
            reincorporateAccordion.appendChild(group);
        });

        // Reutilizamos los listeners pero dentro del contexto del modal de reincorporaci√≥n
        attachReincorporateListeners();
    }

    // 3. Listeners para el modal de reincorporaci√≥n
    function attachReincorporateListeners() {
        reincorporateAccordion.querySelectorAll('.del-order-header').forEach(header => {
            header.addEventListener('click', (e) => {
                if (e.target.type === 'checkbox') return;
                const body = header.nextElementSibling;
                const toggle = header.querySelector('.toggle');
                const isOpen = body.style.display === 'block';
                body.style.display = isOpen ? 'none' : 'block';
                toggle.textContent = isOpen ? '+' : '‚àí';
            });
        });

        reincorporateAccordion.querySelectorAll('.order-checkbox').forEach(orderChk => {
            orderChk.addEventListener('change', (e) => {
                const body = e.target.closest('.del-order-header').nextElementSibling;
                body.querySelectorAll('.item-checkbox').forEach(itemChk => {
                    itemChk.checked = e.target.checked;
                });
            });
        });

        reincorporateAccordion.querySelectorAll('.item-checkbox').forEach(itemChk => {
            itemChk.addEventListener('change', (e) => {
                const body = e.target.closest('.del-order-body');
                const allItemCheckboxes = body.querySelectorAll('.item-checkbox');
                const allChecked = Array.from(allItemCheckboxes).every(chk => chk.checked);
                const orderCheckbox = body.previousElementSibling.querySelector('.order-checkbox');
                orderCheckbox.checked = allChecked;
            });
        });
    }

    // 4. B√∫squeda en el modal de reincorporaci√≥n
    reincorporateSearch.addEventListener('keyup', () => {
        const searchTerm = reincorporateSearch.value.toLowerCase().trim();
        reincorporateAccordion.querySelectorAll('.del-order-group').forEach(group => {
            const orderId = group.dataset.orderId;
            const orderData = allDeletedOrdersData[orderId];
            const searchableText = [
                orderData.orderNumber,
                orderData.customerName,
                orderData.commune,
                orderData.status,
                orderData.van
            ].join(' ').toLowerCase();

            if (searchableText.includes(searchTerm)) {
                group.style.display = '';
            } else {
                group.style.display = 'none';
            }
        });
    });

    // 5. Botones del modal de reincorporaci√≥n
    document.getElementById('cancel-reincorporate-btn').addEventListener('click', () => {
        reincorporateModalOverlay.style.display = 'none';
    });

    document.getElementById('confirm-reincorporate-btn').addEventListener('click', () => {
        const selectedRows = [];
        reincorporateAccordion.querySelectorAll('.item-checkbox:checked').forEach(chk => {
            selectedRows.push(chk.dataset.rowNumber);
        });

        if (selectedRows.length === 0) {
            alert('Por favor, selecciona al menos un producto para reincorporar.');
            return;
        }

        setLoadingState(true, `Reincorporando ${selectedRows.length} fila(s)...`);

        google.script.run
            .withSuccessHandler(response => {
                if (response.status === 'success') {
                    handleSuccess(response.message);
                    reincorporateModalOverlay.style.display = 'none';
                } else {
                    handleError({ message: response.message });
                }
            })
            .withFailureHandler(handleError)
            .reincorporateSelectedRows(selectedRows);
    });
  </script>
</body>
</html>
