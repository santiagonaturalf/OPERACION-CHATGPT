<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
    th { background-color: #f2f2f2; }
    input { width: 90%; padding: 6px; }
    button { padding: 10px 15px; border: none; background-color: #4CAF50; color: white; cursor: pointer; border-radius: 4px; margin-top: 15px; }
    button:disabled { background-color: #ccc; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <h2>Resolver Formatos de Compra Desconocidos</h2>
  <p>El sistema no pudo calcular el costo para los siguientes productos porque su formato de compra no está definido. Por favor, introduce el tamaño de cada formato y guárdalo para continuar.</p>

  <form id="resolve-form">
    <table id="resolve-table">
      <thead>
        <tr>
          <th>Producto Base</th>
          <th>Formato de Compra Desconocido</th>
          <th>¿Cuántas unidades de venta contiene este formato?</th>
        </tr>
      </thead>
      <tbody>
        <!-- Rows will be dynamically inserted here -->
      </tbody>
    </table>
    <button type="submit">Guardar Nuevos Formatos</button>
  </form>

  <script>
    const unresolvedItems = <?= unresolvedItemsJSON ?>;
    const form = document.getElementById('resolve-form');
    const tableBody = document.querySelector("#resolve-table tbody");

    // Populate the table with unresolved items
    window.onload = function() {
      if (!unresolvedItems || unresolvedItems.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="3">No hay formatos para resolver.</td></tr>';
        form.querySelector('button').disabled = true;
        return;
      }

      let tableHtml = '';
      unresolvedItems.forEach(item => {
        tableHtml += `
          <tr>
            <td>${item.productoBase}</td>
            <td>${item.formatoCompra}</td>
            <td><input type="number" step="any" name="size" required> ${item.unidadVenta}</td>
          </tr>
        `;
      });
      tableBody.innerHTML = tableHtml;
    };

    // Handle form submission
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      const button = form.querySelector('button');
      button.disabled = true;
      button.textContent = 'Guardando...';

      const resolvedData = [];
      const rows = tableBody.querySelectorAll('tr');

      rows.forEach((row, index) => {
        const item = unresolvedItems[index];
        const sizeInput = row.querySelector('input[name="size"]');

        if (sizeInput && sizeInput.value) {
          resolvedData.push({
            productoBase: item.productoBase,
            formatoCompra: item.formatoCompra,
            cantidadCompra: parseFloat(sizeInput.value),
            unidadCompra: item.unidadVenta // We use the sale unit as the purchase unit for the new format
          });
        }
      });

      google.script.run
        .withSuccessHandler(function(response) {
          alert(response);
          google.script.host.close();
        })
        .withFailureHandler(function(err) {
          alert('Error al guardar: ' + err.message);
          button.disabled = false;
          button.textContent = 'Guardar Nueuos Formatos';
        })
        .saveResolvedCosts(resolvedData);
    });
  </script>
</body>
</html>
